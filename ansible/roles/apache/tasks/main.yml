---
# Apache Webサーバー設定タスク
- name: Install Apache HTTP Server
  dnf:
    name: httpd
    state: present
  become: yes
  tags: apache,install

- name: Create Apache configuration directory
  file:
    path: /etc/httpd/conf.d
    state: directory
    mode: '0755'
  become: yes
  tags: apache,config

- name: Configure Apache virtual host
  template:
    src: wordpress.conf.j2
    dest: /etc/httpd/conf.d/wordpress.conf
    mode: '0644'
  become: yes
  notify: restart apache
  tags: apache,config,vhost

- name: Create document root directory
  file:
    path: /var/www/html
    state: directory
    mode: '0755'
    owner: apache
    group: apache
  become: yes
  tags: apache,config

- name: Remove test index.html if exists
  file:
    path: /var/www/html/index.html
    state: absent
  become: yes
  tags: apache,config

# HTTPポートを開く（CloudFrontがHTTPSを処理）
- name: Open HTTP port in firewall
  firewalld:
    port: '80/tcp'
    permanent: yes
    state: enabled
  become: yes
  notify: restart firewalld
  tags: apache,firewall

# HTTPSポートを開く（管理画面用の直接アクセス）
- name: Open HTTPS port in firewall
  firewalld:
    port: '443/tcp'
    permanent: yes
    state: enabled
  become: yes
  notify: restart firewalld
  tags: apache,firewall

- name: Enable and start Apache service
  service:
    name: httpd
    state: started
    enabled: yes
  become: yes
  tags: apache,service

- name: Configure Apache to start on boot
  systemd:
    name: httpd
    enabled: yes
    daemon_reload: yes
  become: yes
  tags: apache,service

# PHP-FPMとの連携設定
- name: Create backup of mod_php configuration
  copy:
    src: /etc/httpd/conf.modules.d/20-php.conf
    dest: /etc/httpd/conf.modules.d/20-php.conf.backup
    remote_src: yes
  become: yes
  when: ansible_check_mode is not defined
  ignore_errors: yes
  tags: apache,php-fpm

- name: Disable mod_php configuration
  file:
    path: /etc/httpd/conf.modules.d/20-php.conf
    state: absent
  become: yes
  notify: restart apache
  tags: apache,php-fpm

- name: Ensure mod_proxy_fcgi is enabled
  lineinfile:
    path: /etc/httpd/conf.modules.d/00-proxy.conf
    regexp: '^LoadModule proxy_fcgi_module'
    line: 'LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so'
    state: present
  become: yes
  notify: restart apache
  tags: apache,php-fpm

- name: Ensure mod_rewrite is enabled
  lineinfile:
    path: /etc/httpd/conf.modules.d/00-rewrite.conf
    regexp: '^LoadModule rewrite_module'
    line: 'LoadModule rewrite_module modules/mod_rewrite.so'
    state: present
    create: yes
  become: yes
  notify: restart apache
  tags: apache,rewrite

- name: Create .htaccess file for wp-admin access control
  template:
    src: wp-admin.htaccess.j2
    dest: /var/www/html/wp-admin/.htaccess
    mode: '0644'
    owner: apache
    group: apache
  become: yes
  notify: restart apache
  tags: apache,security

 