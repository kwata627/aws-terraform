# WordPress用Apache設定
# サブドメイン完全分離型設定

# 1. メインサイト HTTP → HTTPS リダイレクト
<VirtualHost *:80>
    ServerName {{ wordpress_domain | default('example.com') }}
    Redirect permanent / https://{{ wordpress_domain | default('example.com') }}/
</VirtualHost>

# 2. 管理画面 HTTP → HTTPS リダイレクト
<VirtualHost *:80>
    ServerName admin.{{ wordpress_domain | default('example.com') }}
    Redirect permanent / https://admin.{{ wordpress_domain | default('example.com') }}/
</VirtualHost>

# 3. 管理画面 HTTPS
<VirtualHost *:443>
    ServerName admin.{{ wordpress_domain | default('example.com') }}
    DocumentRoot /var/www/html
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/{{ wordpress_domain | default('example.com') }}/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/{{ wordpress_domain | default('example.com') }}/privkey.pem

    # クライアントリクエストサイズ制限（管理画面はより大きな制限）
    LimitRequestBody 1073741824
    LimitRequestFieldSize 16384
    LimitRequestLine 8190

    # PHP設定（管理画面専用サブドメイン）
    <IfModule mod_php.c>
        php_value upload_max_filesize 256M
        php_value post_max_size 512M
        php_value max_execution_time 300
        php_value max_input_time 300
        php_value memory_limit 512M
    </IfModule>

    <Directory /var/www/html>
        AllowOverride All
        Require all granted
        Options Indexes FollowSymLinks
    </Directory>

    # 管理画面へのリダイレクト設定
    RewriteEngine On
    RewriteCond %{REQUEST_URI} ^/$
    RewriteRule ^/?$ /wp-admin/ [R=302,L]

    <Directory "/var/www/html/wp-admin">
        <If "%{HTTP_HOST} == 'admin.{{ wordpress_domain | default('example.com') }}'">
            Require all granted
        </If>
        <If "%{HTTP_HOST} != 'admin.{{ wordpress_domain | default('example.com') }}'">
            Require all denied
        </If>
    </Directory>

    # 管理画面専用サブドメインではログインページへのアクセスを許可
    <Location /wp-login.php>
        <If "%{HTTP_HOST} == 'admin.{{ wordpress_domain | default('example.com') }}'">
            Require all granted
        </If>
        <If "%{HTTP_HOST} != 'admin.{{ wordpress_domain | default('example.com') }}'">
            Require all denied
        </If>
    </Location>

    # セキュリティヘッダー
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options SAMEORIGIN
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; img-src 'self' data: https:; frame-src 'self'; object-src 'none';"
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    </IfModule>

    # ログ設定
    ErrorLog logs/wordpress_admin_error.log
    CustomLog logs/wordpress_admin_access.log combined
</VirtualHost>

# 4. 公開サイト HTTPS
<VirtualHost *:443>
    ServerName {{ wordpress_domain | default('example.com') }}
    DocumentRoot /var/www/html
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/{{ wordpress_domain | default('example.com') }}/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/{{ wordpress_domain | default('example.com') }}/privkey.pem

    # クライアントリクエストサイズ制限
    LimitRequestBody 268435456
    LimitRequestFieldSize 16384
    LimitRequestLine 8190

    <Directory /var/www/html>
        AllowOverride All
        Require all granted
        Options Indexes FollowSymLinks
    </Directory>

    # 公開サイトから管理画面へのアクセスを完全に拒否
    <Directory "/var/www/html/wp-admin">
        Require all denied
    </Directory>

    <Location /wp-login.php>
        Require all denied
    </Location>

    # セキュリティヘッダー
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options SAMEORIGIN
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; img-src 'self' data: https:; frame-src 'self'; object-src 'none';"
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    </IfModule>

    # ログ設定
    ErrorLog logs/wordpress_error.log
    CustomLog logs/wordpress_access.log combined
</VirtualHost> 