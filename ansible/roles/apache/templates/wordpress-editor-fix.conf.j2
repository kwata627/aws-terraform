# WordPress用Apache設定（エディタ修正版）
# サブドメイン完全分離型設定

# 1. メインサイト HTTP → HTTPS リダイレクト
<VirtualHost *:80>
    ServerName {{ wordpress_domain | default('example.com') }}
    Redirect permanent / https://{{ wordpress_domain | default('example.com') }}/
</VirtualHost>

# 2. 管理画面 HTTP → HTTPS リダイレクト
<VirtualHost *:80>
    ServerName admin.{{ wordpress_domain | default('example.com') }}
    Redirect permanent / https://admin.{{ wordpress_domain | default('example.com') }}/
</VirtualHost>

# 3. 管理画面 HTTPS（エディタ修正版）
<VirtualHost *:443>
    ServerName admin.{{ wordpress_domain | default('example.com') }}
    DocumentRoot /var/www/html
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/{{ wordpress_domain | default('example.com') }}/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/{{ wordpress_domain | default('example.com') }}/privkey.pem

    # クライアントリクエストサイズ制限（管理画面は大きめに設定）
    LimitRequestBody 67108864
    LimitRequestFieldSize 16384
    LimitRequestLine 8190

    # mod_security アップロードサイズ制限緩和（管理画面用）
    <IfModule mod_security2.c>
        SecRuleEngine On
        SecRequestBodyAccess On
        SecRequestBodyLimit 67108864
        SecRequestBodyNoFilesLimit 67108864
        SecRequestBodyInMemoryLimit 131072
        SecRequestBodyLimitAction ProcessPartial
    </IfModule>

    # PHP-FPM設定
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
    </FilesMatch>

    <Directory /var/www/html>
        AllowOverride All
        Require all granted
        Options Indexes FollowSymLinks
    </Directory>

    # 管理画面へのリダイレクト設定
    RewriteEngine On
    RewriteCond %{REQUEST_URI} ^/$
    RewriteRule ^/?$ /wp-admin/ [R=302,L]

    <Directory "/var/www/html/wp-admin">
        <If "%{HTTP_HOST} == 'admin.{{ wordpress_domain | default('example.com') }}'">
            Require all granted
        </If>
        <If "%{HTTP_HOST} != 'admin.{{ wordpress_domain | default('example.com') }}'">
            Require all denied
        </If>
    </Directory>

    # 管理画面専用サブドメインではログインページへのアクセスを許可
    <Location /wp-login.php>
        <If "%{HTTP_HOST} == 'admin.{{ wordpress_domain | default('example.com') }}'">
            Require all granted
        </If>
        <If "%{HTTP_HOST} != 'admin.{{ wordpress_domain | default('example.com') }}'">
            Require all denied
        </If>
    </Location>

    # WordPressエディタ用の緩いCSP設定（管理画面専用）
    <LocationMatch "^/wp-admin/.*">
        <IfModule mod_headers.c>
            Header always set Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: http: data: blob:; style-src 'self' 'unsafe-inline' https: http: data: blob:; font-src 'self' https: http: data: blob:; img-src 'self' data: blob: https: http:; connect-src 'self' https: http: ws: wss:; frame-src 'self' https: http:; object-src 'none'; media-src 'self' https: http:; worker-src 'self' blob:;"
        </IfModule>
    </LocationMatch>

    # セキュリティヘッダー（管理画面用）
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options SAMEORIGIN
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    </IfModule>

    # ログ設定
    ErrorLog logs/wordpress_admin_error.log
    CustomLog logs/wordpress_admin_access.log combined
</VirtualHost>

# 4. 公開サイト HTTPS
<VirtualHost *:443>
    ServerName {{ wordpress_domain | default('example.com') }}
    DocumentRoot /var/www/html
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/{{ wordpress_domain | default('example.com') }}/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/{{ wordpress_domain | default('example.com') }}/privkey.pem

    # クライアントリクエストサイズ制限（公開側は64MB程度に制限）
    LimitRequestBody 67108864
    LimitRequestFieldSize 16384
    LimitRequestLine 8190

    # mod_security アップロードサイズ制限緩和（公開サイト用）
    <IfModule mod_security2.c>
        SecRuleEngine On
        SecRequestBodyAccess On
        SecRequestBodyLimit 67108864
        SecRequestBodyNoFilesLimit 67108864
        SecRequestBodyInMemoryLimit 131072
        SecRequestBodyLimitAction ProcessPartial
    </IfModule>

    # PHP-FPM設定
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
    </FilesMatch>

    <Directory /var/www/html>
        AllowOverride All
        Require all granted
        Options Indexes FollowSymLinks
    </Directory>

    # 公開サイトから管理画面へのアクセスを完全に拒否
    <Directory "/var/www/html/wp-admin">
        Require all denied
    </Directory>

    <Location /wp-login.php>
        Require all denied
    </Location>

    # セキュリティヘッダー（公開サイト用）
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options SAMEORIGIN
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://*.wordpress.org https://api.wordpress.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://*.wordpress.org; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://*.wordpress.org; img-src 'self' data: https: https://*.wordpress.org; connect-src 'self' https://*.wordpress.org https://api.wordpress.org; frame-src 'self'; object-src 'none';"
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    </IfModule>

    # ログ設定
    ErrorLog logs/wordpress_error.log
    CustomLog logs/wordpress_access.log combined
</VirtualHost>
