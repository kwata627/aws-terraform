# AWS Terraform WordPress IaC構築

## 概要

AWS上にTerraformを用いてWordPressブログ環境をIaCとして構築し、インフラの自動化（効率化）について学習するプロジェクトです。本番環境と検証環境を分離し、自動デプロイメントシステムを実装することで、安全で効率的な運用を実現しています。

## 目的

* Terraformを用いたAWSインフラ構築について学ぶ
* IaCのベストプラクティスについて学ぶ(モジュール化、変数管理など)
* 複数のAWSサービスをIaCで連携させる
* WordPressの自動デプロイと初期設定の自動化を体験
* 検証環境でのテスト後に本番環境への安全な反映を実現
* 自身のポートフォリオとしての活用

## システム構成

```
+--------------------+
|  Route53     | ← 独自ドメイン管理（example.com）
+--------------------+
      |
      ▼
+--------------------+
|  CloudFront    | ← 静的ファイル配信 / HTTPS (ACM) [一時的に無効化]
+--------------------+
      |
      ▼
  +--------------------------+
  |     S3       | ← 画像ファイル・ログ保存（限定公開）
  +--------------------------+
  +-----------------------------------------------+
  |         VPC (CIDR: 10.0.0.0/16)    |
  |-----------------------------------------------|
  | Public Subnet (10.0.1.0/24)         |
  |  + EC2 NATインスタンス（t3.nano）       |
  |  + EC2 WordPress本番（t2.micro）       |
  |-----------------------------------------------|
  | Private Subnet (10.0.2.0/24)         |
  |  + RDS MySQL（db.t3.micro）          |
  |  + 検証用EC2（※基本停止）          |
  |-----------------------------------------------|
  | IGW（Internet Gateway）           |
  | NATルート（NATインスタンス経由）        |
  +-----------------------------------------------+
```

## 統合管理スクリプト

### 使用方法

```bash
# ヘルプ表示
./manage.sh help

# 設定ファイル生成
./manage.sh config example.com 20250803

# デプロイメント実行
./manage.sh deploy production

# 検証環境準備
./manage.sh validate

# 環境状況確認
./manage.sh status

# SSH許可IP更新
./manage.sh ssh-update

# ロールバック実行
./manage.sh rollback

# ログ確認
./manage.sh logs
```

### コマンド一覧

| コマンド | 説明 | 例 |
|---------|------|-----|
| `config <domain> <date>` | 設定ファイル生成 | `./manage.sh config example.com 20250803` |
| `deploy [environment]` | デプロイメント実行 | `./manage.sh deploy production` |
| `validate` | 検証環境準備 | `./manage.sh validate` |
| `rollback` | ロールバック実行 | `./manage.sh rollback` |
| `ssh-update` | SSH許可IP更新 | `./manage.sh ssh-update` |
| `logs` | ログ確認 | `./manage.sh logs` |
| `status` | 環境状況確認 | `./manage.sh status` |
| `help` | ヘルプ表示 | `./manage.sh help` |

## 構成の意図と工夫した点

### 1. ネットワーク基盤の設計

**工夫点:**
- **VPC分離**: 独立したネットワーク空間を確保し、セキュリティを向上
- **サブネット分離**: パブリック/プライベートサブネットで役割を明確に分離
- **NATインスタンス**: NAT Gatewayの代わりにt3.nanoインスタンスを使用し、コスト削減を実現
- **マルチAZ構成**: RDSを2つのAZに配置し、可用性を確保

### 2. セキュリティ設計

**工夫点:**
- **最小権限の原則**: セキュリティグループで必要最小限の通信のみ許可
- **プライベートサブネット**: RDSをプライベートサブネットに配置し、直接アクセスを遮断
- **SSH鍵自動生成**: RSA鍵を自動生成し、セキュアなアクセスを実現
- **ACM証明書**: HTTPS通信の自動化

### 3. モジュール化設計

**工夫点:**
- **再利用性**: 各AWSリソースを個別モジュールとして分離
- **保守性**: モジュール単位での更新・修正が可能
- **可読性**: 明確な責任分離でコードの理解を促進

## 自動化箇所

### 1. インフラ自動化（Terraform）
- **VPC・サブネット**: ネットワーク基盤の自動構築
- **EC2・RDS**: サーバー・データベースの自動プロビジョニング
- **セキュリティグループ**: 通信制御の自動設定
- **Route53・ACM**: ドメイン管理・SSL証明書の自動化

### 2. アプリケーション自動化（Ansible）
- **WordPress設定**: UserDataからAnsibleへの移行により柔軟な設定管理
- **段階的デプロイ**: タグ付きで段階的な環境構築が可能
- **環境別管理**: 本番/開発環境の設定分離

### 3. デプロイメント自動化
- **自動デプロイメント**: 検証環境でのテスト後に本番環境への自動反映
- **スナップショット管理**: 安全な更新プロセスの実現
- **ロールバック機能**: 問題発生時の自動復旧

## コスト最適化とベストプラクティス

### 1. コスト最適化
- **NATインスタンス**: NAT Gatewayの代わりにt3.nanoを使用
- **検証環境**: 基本停止状態でコストを最小化
- **インスタンスタイプ**: 必要最小限のスペックで運用
- **S3ライフサイクル**: 古いログファイルの自動削除

### 2. IaCベストプラクティス
- **モジュール化**: 再利用可能なコンポーネント設計
- **変数管理**: 環境別設定の外部化
- **状態管理**: Terraform stateの適切な管理
- **バージョン管理**: コードの変更履歴を追跡

### 3. 運用ベストプラクティス
- **検証環境**: 本番環境への影響を最小化
- **自動化**: 人的ミスの削減
- **監視**: ログとメトリクスの収集
- **バックアップ**: 定期的なスナップショット作成

## セキュリティ対策

### 1. ネットワークセキュリティ
- **VPC分離**: 独立したネットワーク環境
- **セキュリティグループ**: 最小権限での通信制御
- **プライベートサブネット**: データベースの直接アクセス遮断

### 2. アクセス制御
- **SSH鍵管理**: 自動生成されたRSA鍵による安全なアクセス
- **IAMロール**: 最小権限でのAWSリソースアクセス
- **セキュリティグループ**: 役割別の通信制御

### 3. データ保護
- **RDS暗号化**: 保存時・転送時の暗号化
- **S3暗号化**: オブジェクトレベルの暗号化
- **SSL/TLS**: HTTPS通信の強制

## 改善余地と今後の展望

### 1. 短期的改善
- **CloudFront有効化**: CDN機能の復活によるパフォーマンス向上
- **監視強化**: CloudWatchアラームの追加
- **ログ管理**: 集中ログ管理システムの導入

### 2. 中期的改善
- **コンテナ化**: Docker/Kubernetesへの移行検討
- **CI/CD強化**: GitHub Actionsとの連携
- **マルチリージョン**: 災害対策の強化

### 3. 長期的展望
- **サーバーレス**: Lambda + API Gatewayへの移行
- **AI/ML統合**: 自動スケーリング・異常検知の実装

## 使用方法

### 1. 初期セットアップ
```bash
# 設定ファイル生成
./manage.sh config your-domain.com 20250803

# Terraformの初期化
terraform init

# インフラの構築
terraform plan
terraform apply
```

### 2. WordPress設定
```bash
# Ansibleの実行
cd ansible
python3 generate_inventory.py
ansible-playbook playbooks/wordpress_setup.yml
```

### 3. 自動デプロイメント
```bash
# デプロイメントシステムの初期化
./manage.sh validate

# 自動デプロイメントの実行
./manage.sh deploy production
```

## 技術スタック

- **IaC**: Terraform
- **設定管理**: Ansible
- **Webサーバー**: Apache
- **データベース**: MySQL (RDS)
- **言語**: PHP
- **CMS**: WordPress
- **クラウド**: AWS
- **監視**: CloudWatch （予定）
- **CI/CD**: GitHub Actions（予定）

## ライセンス

このプロジェクトは学習目的で作成されており、個人利用を想定しています。
