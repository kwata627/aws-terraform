# 検証環境運用ガイド

## 目次
1. [概要](#概要)
2. [設計方針](#設計方針)
3. [運用フロー](#運用フロー)
4. [GitHub Actionsでの運用](#github-actionsでの運用)
5. [コスト分析](#コスト分析)
6. [セキュリティ考慮事項](#セキュリティ考慮事項)
7. [運用ベストプラクティス](#運用ベストプラクティス)
8. [トラブルシューティング](#トラブルシューティング)
9. [定期メンテナンス](#定期メンテナンス)
10. [セキュリティガイドライン](#セキュリティガイドライン)

---

## 概要

このガイドは、WordPress検証環境の運用方針とベストプラクティスを説明します。コスト削減とセキュリティを考慮した運用方法を提案します。

### 検証環境の目的
- **安全なテスト**: 本番環境に影響を与えずに変更をテスト
- **コスト最適化**: 必要な時だけ起動してコストを削減
- **セキュリティ強化**: 不要時は停止してセキュリティリスクを軽減
- **品質保証**: 本番環境と同一の状態でのテスト
- **自動化**: GitHub Actionsによる完全自動化

---

## 設計方針

### 基本原則
- **必要な時だけ起動**: コスト削減のため、使用時のみ起動
- **本番環境と同一の状態**: スナップショットから復元して同一性を保証
- **セキュリティ優先**: 不要時は停止してセキュリティリスクを軽減
- **自動化**: GitHub Actionsによる手動操作の最小化

### 現在の設定
```hcl
# terraform.tfvars
enable_validation_ec2 = true    # 検証用EC2（停止状態で作成）
enable_validation_rds = false   # 検証用RDS（停止状態で作成）
```

### ネットワーク構成
- **プライベートサブネット**: 外部からの直接アクセス不可
- **NAT経由アクセス**: 制限されたアクセス
- **セキュリティグループ**: 最小権限の設定
- **VPC**: 分離されたネットワーク環境

---

## 運用フロー

### 1. 通常時（停止状態）
```
検証環境EC2: 停止中
検証環境RDS: 停止中
コスト: 最小限（ストレージ料金のみ）
セキュリティ: 外部アクセス完全遮断
監視: 定期的な状態確認
```

### 2. 使用時（起動状態）
```
検証環境EC2: 起動中
検証環境RDS: 起動中（スナップショットから復元）
コスト: 約$25-30/月
セキュリティ: NAT経由での制限されたアクセス
監視: リアルタイム監視
```

### 3. 使用後（停止状態）
```
検証環境EC2: 停止
検証環境RDS: 停止
コスト: 最小限に戻る
セキュリティ: 外部アクセス完全遮断
クリーンアップ: 一時ファイルの削除
```

---

## GitHub Actionsでの運用

### 利用可能なワークフロー

#### 1. Prepare Validation
- **ファイル**: `.github/workflows/prepare-validation.yml`
- **目的**: 検証環境の準備と起動
- **トリガー**: 手動実行
- **機能**:
  - 本番環境のスナップショット作成
  - 検証環境の起動
  - スナップショットからの復元
  - 基本的な動作確認
  - 自動クリーンアップ（オプション）

#### 2. Auto Deployment
- **ファイル**: `.github/workflows/auto-deployment.yml`
- **目的**: 検証環境でのテスト後に本番環境への自動デプロイ
- **トリガー**: 手動実行、WordPressコンテンツ変更
- **機能**:
  - 検証環境でのテスト実行
  - 承認フロー（手動/自動）
  - 本番環境への反映
  - 検証環境のクリーンアップ

#### 3. Rollback Deployment
- **ファイル**: `.github/workflows/rollback.yml`
- **目的**: 問題発生時の本番環境のロールバック
- **トリガー**: 手動実行
- **機能**:
  - 指定したスナップショットからの復元
  - ロールバック後の動作確認

### ワークフロー実行手順

#### 1. 検証環境の準備

1. **GitHubリポジトリのActionsタブにアクセス**
2. **Prepare Validation** ワークフローを選択
3. **Run workflow** をクリック
4. 必要なパラメータを入力：
   - `snapshot_id`: 使用するスナップショットID（空の場合は最新）
   - `test_timeout_minutes`: テストタイムアウト時間（デフォルト: 30）
   - `auto_cleanup`: 自動クリーンアップの有効/無効
5. **Run workflow** をクリックして実行開始

#### 2. 検証環境でのテスト

1. **検証環境へのアクセス**
   - ワークフロー完了後、検証環境のIPアドレスを確認
   - `http://[検証IP]/wp-admin` にアクセス

2. **テストの実行**
   - 新規記事の作成・編集
   - プラグインの設定変更
   - テーマの変更
   - パフォーマンステスト

3. **テスト結果の確認**
   - サイトの表示確認
   - 管理画面の動作確認
   - データベース接続確認

#### 3. 本番環境への反映

1. **Auto Deploymentワークフローの実行**
   - **Auto Deployment** ワークフローを選択
   - **Run workflow** をクリック
   - 必要なパラメータを入力：
     - `environment`: `production`
     - `auto_approve`: 自動承認の有効/無効
     - `dry_run`: ドライランの有効/無効
     - `backup_before_deployment`: デプロイ前バックアップの有効/無効
   - **Run workflow** をクリックして実行開始

2. **デプロイメントプロセスの監視**
   - ワークフローの実行状況を確認
   - 各ステップのログを確認
   - エラーや警告に注意

3. **完了後の確認**
   - 本番環境の動作確認
   - 検証環境のクリーンアップ確認

### 自動化のメリット

#### 1. 安全性の向上
- **承認フロー**: 手動承認による安全な実行
- **セキュアな認証**: GitHub Secretsによる安全な認証情報管理
- **実行履歴**: 完全な実行履歴の記録

#### 2. 効率性の向上
- **自動実行**: コードプッシュやスケジュールによる自動実行
- **並列処理**: 独立したジョブの並列実行
- **統合環境**: 開発からデプロイまで一貫した環境

#### 3. 可視性の向上
- **リアルタイム監視**: 実行状況のリアルタイム確認
- **詳細ログ**: 各ステップの詳細なログ記録
- **アーティファクト**: 実行結果の自動保存

---

## コスト分析

### 停止時のコスト
- **EC2**: $0/月（停止中は課金なし）
- **RDS**: $0/月（停止中は課金なし）
- **EBS**: 約$1/月（8GB GP2）
- **合計**: 約$1/月

### 起動時のコスト
- **EC2 t2.micro**: 約$8-10/月
- **RDS db.t3.micro**: 約$15-20/月
- **EBS**: 約$1/月
- **合計**: 約$25-30/月

### コスト削減効果
- **月間使用時間**: 10時間/月と仮定
- **従来の常時起動**: $25-30/月
- **現在の運用**: 約$1/月
- **削減効果**: 約$24-29/月（80-97%削減）

### コスト最適化のポイント

#### 1. 使用時間の最小化
- **必要な時だけ起動**: テスト時のみ起動
- **迅速なテスト**: 効率的なテスト実行
- **自動クリーンアップ**: 使用後の即座停止

#### 2. リソースの最適化
- **最小スペック**: 必要最小限のインスタンスタイプ
- **ストレージ最適化**: 必要最小限のストレージ容量
- **ネットワーク最適化**: 効率的なネットワーク構成

#### 3. 自動化による効率化
- **手動操作の削減**: 人的ミスの削減
- **迅速な実行**: 自動化による時間短縮
- **正確な制御**: プログラムによる正確な制御

---

## セキュリティ考慮事項

### 1. ネットワークセキュリティ

#### プライベートサブネット
- **外部アクセス遮断**: インターネットからの直接アクセス不可
- **NAT経由アクセス**: 制限されたアクセス経路
- **セキュリティグループ**: 最小権限での通信制御

#### アクセス制御
- **SSHアクセス**: 特定IPからのみ許可
- **データベースアクセス**: アプリケーションからのみ許可
- **管理画面アクセス**: 認証されたユーザーのみ許可

### 2. データセキュリティ

#### データ保護
- **暗号化**: 保存時・転送時の暗号化
- **バックアップ**: 定期的なバックアップ作成
- **アクセス制御**: 最小権限でのアクセス制御

#### 機密情報管理
- **GitHub Secrets**: 認証情報の安全な管理
- **環境変数**: 機密情報の環境変数化
- **アクセスログ**: すべてのアクセスの記録

### 3. 運用セキュリティ

#### 監視とアラート
- **リアルタイム監視**: 異常の即座検知
- **セキュリティアラート**: セキュリティイベントの通知
- **ログ分析**: セキュリティログの分析

#### インシデント対応
- **迅速な対応**: 問題発生時の即座対応
- **ロールバック機能**: 安全な復旧機能
- **通知システム**: 関係者への即座通知

---

## 運用ベストプラクティス

### 1. 検証環境の準備

#### 事前準備
- [ ] 本番環境のバックアップ確認
- [ ] 必要なシークレットの設定確認
- [ ] リソース識別子の確認
- [ ] 承認者の設定確認

#### 実行時の確認
- [ ] ワークフローの実行状況確認
- [ ] 各ステップのログ確認
- [ ] エラーや警告の確認
- [ ] リソースの状態確認

### 2. テストの実行

#### テスト項目
- [ ] WordPressサイトの表示確認
- [ ] 管理画面へのログイン確認
- [ ] 新規投稿の作成確認
- [ ] 既存記事の編集確認
- [ ] 画像アップロードの確認
- [ ] プラグインの動作確認
- [ ] テーマの変更確認
- [ ] パフォーマンステスト

#### テスト方法
- **機能テスト**: 各機能の動作確認
- **統合テスト**: 機能間の連携確認
- **パフォーマンステスト**: レスポンス時間の確認
- **セキュリティテスト**: セキュリティ機能の確認

### 3. 本番環境への反映

#### 反映前の確認
- [ ] 検証環境でのテスト完了確認
- [ ] 本番環境のバックアップ確認
- [ ] 承認者の承認確認
- [ ] 通知設定の確認

#### 反映後の確認
- [ ] 本番環境の動作確認
- [ ] パフォーマンスの確認
- [ ] セキュリティログの確認
- [ ] 検証環境のクリーンアップ確認

### 4. クリーンアップ

#### 自動クリーンアップ
- **リソースの停止**: 検証環境の自動停止
- **一時ファイルの削除**: 不要ファイルの削除
- **ログの保存**: 重要なログの保存

#### 手動クリーンアップ
- **確認事項**: クリーンアップの完了確認
- **ログの確認**: クリーンアップログの確認
- **コストの確認**: コスト削減の確認

---

## トラブルシューティング

### 1. よくある問題と対処法

#### 検証環境が起動しない
**原因**: リソース不足、設定エラー、権限不足
**対処法**:
1. AWSリソースの状態確認
2. 設定ファイルの確認
3. IAM権限の確認

#### スナップショットが見つからない
**原因**: スナップショットの削除、権限不足、リージョン違い
**対処法**:
1. スナップショットの存在確認
2. 権限の確認
3. リージョンの確認

#### 検証環境にアクセスできない
**原因**: ネットワーク設定、セキュリティグループ、NAT問題
**対処法**:
1. ネットワーク設定の確認
2. セキュリティグループの確認
3. NATインスタンスの確認

#### テストが失敗する
**原因**: アプリケーションエラー、データベース問題、設定エラー
**対処法**:
1. アプリケーションログの確認
2. データベース接続の確認
3. 設定ファイルの確認

### 2. GitHub Actions関連の問題

#### ワークフローが失敗する
**原因**: 認証エラー、リソース見つからない、権限不足
**対処法**:
1. GitHub Secretsの確認
2. AWSリソースの存在確認
3. IAM権限の確認

#### 承認フローで止まる
**原因**: 承認者の設定ミス、承認シークレットの誤り
**対処法**:
1. 承認者の設定確認
2. 承認シークレットの確認
3. 承認プロセスの確認

### 3. 緊急時の対応

#### 検証環境が起動しない場合
1. **手動での起動**
   - AWSコンソールでの手動起動
   - 設定の確認と修正

2. **代替手段の検討**
   - 本番環境での直接テスト
   - ローカル環境でのテスト

#### テストが失敗する場合
1. **問題の特定**
   - ログの詳細確認
   - 設定の確認

2. **修正と再テスト**
   - 問題の修正
   - 再テストの実行

---

## 定期メンテナンス

### 1. 日次メンテナンス

#### 確認項目
- [ ] 検証環境の状態確認
- [ ] ワークフローの実行状況確認
- [ ] ログの確認
- [ ] エラーの確認

#### 実行コマンド
```bash
# 検証環境の状態確認
aws ec2 describe-instances --instance-ids [検証用EC2のID]

# ワークフローの実行状況確認
gh run list --limit 5

# ログの確認
tail -f /var/log/apache2/error.log
```

### 2. 週次メンテナンス

#### 確認項目
- [ ] スナップショットの確認
- [ ] パフォーマンスの確認
- [ ] セキュリティの確認
- [ ] コストの確認

#### 実行コマンド
```bash
# スナップショットの確認
aws rds describe-db-snapshots --db-instance-identifier wp-example-rds

# パフォーマンスの確認
aws cloudwatch get-metric-statistics --namespace AWS/EC2 --metric-name CPUUtilization

# セキュリティの確認
aws ec2 describe-security-groups --group-ids sg-xxxxxxxxx
```

### 3. 月次メンテナンス

#### 確認項目
- [ ] システム全体の見直し
- [ ] セキュリティ設定の確認
- [ ] コストの見直し
- [ ] ドキュメントの更新

#### 実行コマンド
```bash
# システム全体の確認
terraform plan

# コストの確認
aws ce get-cost-and-usage --time-period Start=2024-01-01,End=2024-01-31

# セキュリティ設定の確認
aws config get-compliance-details-by-config-rule --config-rule-name required-tags
```

### 4. 四半期メンテナンス

#### 確認項目
- [ ] アーキテクチャの見直し
- [ ] セキュリティ監査の実施
- [ ] パフォーマンス最適化
- [ ] ベストプラクティスの更新

---

## セキュリティガイドライン

### 1. アクセス制御

#### SSHアクセス
- **許可IPの制限**: 特定のIPレンジからのみアクセス許可
- **SSH鍵の管理**: 強力なSSH鍵の使用と定期更新
- **ユーザー権限**: 必要最小限の権限のみ付与

#### データベースアクセス
- **最小権限の原則**: 必要最小限の権限のみ付与
- **接続制限**: 特定のIPからのみ接続許可
- **認証情報の管理**: 強力なパスワードの使用

### 2. データ保護

#### バックアップ
- **自動バックアップ**: RDSの自動バックアップを有効化
- **手動スナップショット**: 重要な変更前の手動バックアップ
- **バックアップ暗号化**: すべてのバックアップの暗号化

#### 通信暗号化
- **HTTPS**: WordPressサイトの暗号化通信
- **SSH**: サーバーアクセスの暗号化
- **RDS**: データベース接続の暗号化

### 3. 監視とログ

#### ログ監視
- **アクセスログ**: 不正アクセスの検知
- **エラーログ**: システムエラーの監視
- **セキュリティログ**: セキュリティイベントの記録

#### アラート設定
- **高負荷検知**: CPU使用率80%以上
- **ディスク容量不足**: 使用率90%以上
- **セキュリティ違反**: 不正アクセスの検知

### 4. 定期セキュリティチェック

#### 週次チェック
- [ ] セキュリティログの確認
- [ ] 不正アクセスの確認
- [ ] パッチの適用状況確認

#### 月次チェック
- [ ] セキュリティ設定の見直し
- [ ] アクセス権限の確認
- [ ] 脆弱性スキャンの実施

#### 四半期チェック
- [ ] セキュリティ監査の実施
- [ ] セキュリティポリシーの見直し
- [ ] インシデント対応計画の更新

---

## まとめ

この検証環境運用ガイドに従って、安全で効率的な検証環境の運用を実現してください。

### 重要なポイント
1. **安全性**: プライベートサブネットとセキュリティグループ
2. **効率性**: GitHub Actionsによる自動化
3. **コスト最適化**: 必要な時だけ起動
4. **品質保証**: 本番環境と同一の状態でのテスト

### 今後の改善
1. **監視強化**: より詳細な監視機能の追加
2. **自動化拡張**: より多くの作業の自動化
3. **セキュリティ強化**: より厳格なセキュリティ設定
4. **パフォーマンス最適化**: 実行時間の短縮

このシステムを活用して、安全で効率的な検証環境の運用を実現してください。 