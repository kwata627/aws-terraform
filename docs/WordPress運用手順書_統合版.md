# WordPress運用手順書

## 目次
1. [概要](#概要)
2. [環境構成](#環境構成)
3. [基本的な運用手順](#基本的な運用手順)
4. [記事更新手順](#記事更新手順)
5. [GitHub Actionsでの運用](#github-actionsでの運用)
6. [トラブルシューティング](#トラブルシューティング)
7. [定期メンテナンス](#定期メンテナンス)
8. [セキュリティガイドライン](#セキュリティガイドライン)

---

## 概要

この手順書は、AWS上で動作するWordPressブログの基本的な運用手順を説明します。
**重要な原則**: すべての変更は必ず検証環境でテストしてから本番環境に反映してください。

### 環境の特徴
- **本番環境**: 一般公開されているWordPressサイト（常時起動）
- **検証環境**: 変更をテストするための環境（必要時のみ起動）
- **データベース**: RDS MySQL（自動バックアップあり）
- **セキュリティ**: 多層防御によるセキュリティ強化
- **自動化**: GitHub Actionsによる完全自動化

---

## 環境構成

### 本番環境
- **サーバー**: EC2（t2.micro）
- **データベース**: RDS MySQL（db.t3.micro）
- **ドメイン**: example.com
- **アクセス**: インターネットから直接アクセス可能
- **セキュリティ**: WAF、セキュリティグループ、暗号化通信

### 検証環境
- **サーバー**: 検証用EC2（通常は停止状態）
- **データベース**: 検証用RDS（本番データのコピー）
- **アクセス**: NAT経由でのみアクセス可能
- **セキュリティ**: プライベートサブネット、制限されたアクセス

---

## 基本的な運用手順

### 1. 環境情報の確認

```bash
# 現在の環境情報を確認
terraform output

# 本番環境のIPアドレス
terraform output -raw wordpress_public_ip

# 検証環境のIPアドレス
terraform output -raw validation_private_ip

# 接続情報の確認
terraform output -raw connection_info
```

### 2. WordPress管理画面へのアクセス

1. **本番環境**: `https://example.com/wp-admin`
2. **検証環境**: `http://[検証IP]/wp-admin`

### 3. 日常的な確認事項

- [ ] サイトが正常に表示されるか
- [ ] 管理画面にログインできるか
- [ ] 新規投稿が作成できるか
- [ ] コメントが正常に表示されるか
- [ ] SSL証明書が有効か
- [ ] セキュリティログに異常がないか

---

## 記事更新手順

### 手順1: GitHub Actionsでの検証環境準備

1. **GitHubリポジトリのActionsタブにアクセス**
2. **Prepare Validation** ワークフローを選択
3. **Run workflow** をクリック
4. 必要なパラメータを入力：
   - `snapshot_id`: 使用するスナップショットID（空の場合は最新）
   - `test_timeout_minutes`: テストタイムアウト時間（デフォルト: 30）
   - `auto_cleanup`: 自動クリーンアップの有効/無効
5. **Run workflow** をクリックして実行開始

**実行される処理:**
- 本番環境のスナップショット作成
- 検証環境の起動（スナップショットから復元）
- 検証環境の準備完了待機
- 基本的な動作確認

### 手順2: 検証環境での記事作成・テスト

1. **検証環境にアクセス**
   - 検証環境のIPアドレスを確認
   - `http://[検証IP]/wp-admin` にアクセス

2. **記事の作成・編集**
   - 新規投稿の作成
   - 既存記事の編集
   - 画像のアップロード
   - プラグインの設定変更

3. **動作確認**
   - サイトの表示確認
   - 管理画面の動作確認
   - データベース接続確認
   - パフォーマンステスト

### 手順3: 本番環境への反映

1. **GitHub Actionsでの自動デプロイメント**
   - **Auto Deployment** ワークフローを選択
   - **Run workflow** をクリック
   - 必要なパラメータを入力：
     - `environment`: `production`
     - `auto_approve`: 自動承認の有効/無効
     - `dry_run`: ドライランの有効/無効
     - `backup_before_deployment`: デプロイ前バックアップの有効/無効
   - **Run workflow** をクリックして実行開始

2. **デプロイメントプロセス**
   - 本番環境のバックアップ作成
   - 検証環境から本番環境へのデータ同期
   - 本番環境の動作確認
   - 検証環境のクリーンアップ

### 手順4: 本番環境の確認

1. **サイトの動作確認**
   - 本番サイトの表示確認
   - 新規記事の表示確認
   - 管理画面の動作確認

2. **パフォーマンス確認**
   - ページ読み込み速度の確認
   - データベース接続の確認
   - エラーログの確認

---

## GitHub Actionsでの運用

### 利用可能なワークフロー

#### 1. WordPress Environment Setup
- **目的**: WordPress環境の構築と設定
- **使用場面**: 初回セットアップ、環境再構築
- **実行方法**: GitHub Actionsタブから手動実行

#### 2. Auto Deployment
- **目的**: 検証環境から本番環境への自動デプロイ
- **使用場面**: 記事更新、設定変更
- **実行方法**: 手動実行または自動トリガー

#### 3. Rollback Deployment
- **目的**: 問題発生時の本番環境のロールバック
- **使用場面**: デプロイメント失敗、動作異常
- **実行方法**: GitHub Actionsタブから手動実行

#### 4. Prepare Validation
- **目的**: 検証環境の準備
- **使用場面**: テスト環境の起動
- **実行方法**: GitHub Actionsタブから手動実行

#### 5. Update SSH CIDR
- **目的**: SSH許可IPの更新
- **使用場面**: IPアドレス変更時
- **実行方法**: 手動実行または定期実行（毎週月曜日）

### ワークフロー実行のベストプラクティス

#### 1. 実行前の確認
- [ ] 必要なシークレットが設定されている
- [ ] リソース識別子が正しく設定されている
- [ ] 承認者が設定されている（手動承認の場合）

#### 2. 実行中の監視
- [ ] GitHub Actionsの実行状況を確認
- [ ] 各ステップのログを確認
- [ ] エラーや警告に注意

#### 3. 実行後の確認
- [ ] 実行結果の確認
- [ ] アーティファクトの確認
- [ ] 通知の確認

---

## トラブルシューティング

### 1. よくある問題と対処法

#### WordPressサイトが表示されない
**原因**: サーバーの停止、ネットワーク問題、設定エラー
**対処法**:
1. EC2インスタンスの状態確認
2. セキュリティグループの設定確認
3. WordPress設定ファイルの確認

#### 管理画面にログインできない
**原因**: パスワード忘れ、データベース接続エラー、権限問題
**対処法**:
1. パスワードリセット
2. データベース接続確認
3. ファイル権限の確認

#### 画像が表示されない
**原因**: ファイル権限、ディスク容量不足、設定エラー
**対処法**:
1. ファイル権限の確認と修正
2. ディスク容量の確認
3. WordPress設定の確認

#### データベース接続エラー
**原因**: RDS停止、ネットワーク問題、認証エラー
**対処法**:
1. RDSインスタンスの状態確認
2. セキュリティグループの設定確認
3. データベース認証情報の確認

### 2. GitHub Actions関連の問題

#### ワークフローが失敗する
**原因**: 認証エラー、リソース見つからない、権限不足
**対処法**:
1. GitHub Secretsの確認
2. AWSリソースの存在確認
3. IAM権限の確認

#### 承認フローで止まる
**原因**: 承認者の設定ミス、承認シークレットの誤り
**対処法**:
1. 承認者の設定確認
2. 承認シークレットの確認
3. 承認プロセスの確認

### 3. 緊急時の対応

#### サイトが完全にダウンした場合
1. **即座のロールバック**
   - GitHub ActionsでRollback Deploymentを実行
   - 最新の正常スナップショットから復元

2. **手動での復旧**
   - EC2インスタンスの再起動
   - RDSインスタンスの確認
   - 設定ファイルの確認

3. **原因の特定**
   - ログの確認
   - リソースの状態確認
   - 設定変更の確認

#### データベースが破損した場合
1. **バックアップからの復元**
   - 最新のスナップショットから復元
   - データベースの整合性確認

2. **WordPressファイルの確認**
   - 設定ファイルの確認
   - プラグインの確認

---

## 定期メンテナンス

### 1. 日次メンテナンス

#### 確認項目
- [ ] サイトの動作確認
- [ ] 管理画面のアクセス確認
- [ ] エラーログの確認
- [ ] セキュリティログの確認

#### 実行コマンド
```bash
# サイトの動作確認
curl -I https://example.com

# 管理画面のアクセス確認
curl -I https://example.com/wp-admin

# ログの確認
tail -f /var/log/apache2/error.log
```

### 2. 週次メンテナンス

#### 確認項目
- [ ] バックアップの確認
- [ ] パフォーマンスの確認
- [ ] セキュリティの確認
- [ ] プラグインの更新確認

#### 実行コマンド
```bash
# バックアップの確認
aws rds describe-db-snapshots --db-instance-identifier wp-example-rds

# パフォーマンスの確認
aws cloudwatch get-metric-statistics --namespace AWS/EC2 --metric-name CPUUtilization

# セキュリティの確認
aws ec2 describe-security-groups --group-ids sg-xxxxxxxxx
```

### 3. 月次メンテナンス

#### 確認項目
- [ ] システム全体の見直し
- [ ] セキュリティ設定の確認
- [ ] コストの確認
- [ ] ドキュメントの更新

#### 実行コマンド
```bash
# システム全体の確認
terraform plan

# コストの確認
aws ce get-cost-and-usage --time-period Start=2024-01-01,End=2024-01-31

# セキュリティ設定の確認
aws config get-compliance-details-by-config-rule --config-rule-name required-tags
```

### 4. 四半期メンテナンス

#### 確認項目
- [ ] アーキテクチャの見直し
- [ ] セキュリティ監査の実施
- [ ] パフォーマンス最適化
- [ ] ベストプラクティスの更新

---

## セキュリティガイドライン

### 1. アクセス制御

#### SSHアクセス
- **許可IPの制限**: 特定のIPレンジからのみアクセス許可
- **SSH鍵の管理**: 強力なSSH鍵の使用と定期更新
- **ユーザー権限**: 必要最小限の権限のみ付与

#### WordPress管理
- **強力なパスワード**: 複雑なパスワードの使用
- **二要素認証**: 可能な限り二要素認証を有効化
- **ユーザー権限**: 適切な権限レベルの設定

### 2. データ保護

#### バックアップ
- **自動バックアップ**: RDSの自動バックアップを有効化
- **手動スナップショット**: 重要な変更前の手動バックアップ
- **バックアップ暗号化**: すべてのバックアップの暗号化

#### 通信暗号化
- **HTTPS**: WordPressサイトの暗号化通信
- **SSH**: サーバーアクセスの暗号化
- **RDS**: データベース接続の暗号化

### 3. 監視とログ

#### ログ監視
- **アクセスログ**: 不正アクセスの検知
- **エラーログ**: システムエラーの監視
- **セキュリティログ**: セキュリティイベントの記録

#### アラート設定
- **高負荷検知**: CPU使用率80%以上
- **ディスク容量不足**: 使用率90%以上
- **セキュリティ違反**: 不正アクセスの検知

### 4. 定期セキュリティチェック

#### 週次チェック
- [ ] セキュリティログの確認
- [ ] 不正アクセスの確認
- [ ] パッチの適用状況確認

#### 月次チェック
- [ ] セキュリティ設定の見直し
- [ ] アクセス権限の確認
- [ ] 脆弱性スキャンの実施

#### 四半期チェック
- [ ] セキュリティ監査の実施
- [ ] セキュリティポリシーの見直し
- [ ] インシデント対応計画の更新

---

## まとめ

この運用手順書に従って、安全で効率的なWordPress環境の運用を実現してください。

### 重要なポイント
1. **安全性**: 検証環境でのテストと承認フロー
2. **効率性**: GitHub Actionsによる自動化
3. **監視**: 定期的な監視とログ確認
4. **セキュリティ**: 多層防御によるセキュリティ強化

### 今後の改善
1. **監視強化**: より詳細な監視機能の追加
2. **自動化拡張**: より多くの作業の自動化
3. **セキュリティ強化**: より厳格なセキュリティ設定
4. **パフォーマンス最適化**: 実行時間の短縮

このシステムを活用して、安全で効率的なWordPress環境の運用を実現してください。 