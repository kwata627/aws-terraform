# WordPress運用手順書

## 目次
1. [概要](#概要)
2. [環境構成](#環境構成)
3. [基本的な運用手順](#基本的な運用手順)
4. [記事更新手順](#記事更新手順)
5. [トラブルシューティング](#トラブルシューティング)
6. [定期メンテナンス](#定期メンテナンス)

---

## 概要

この手順書は、AWS上で動作するWordPressブログの基本的な運用手順を説明します。
**重要な原則**: すべての変更は必ず検証環境でテストしてから本番環境に反映してください。

### 環境の特徴
- **本番環境**: 一般公開されているWordPressサイト（常時起動）
- **検証環境**: 変更をテストするための環境（必要時のみ起動）
- **データベース**: RDS MySQL（自動バックアップあり）

---

## 環境構成

### 本番環境
- **サーバー**: EC2（t2.micro）
- **データベース**: RDS MySQL（db.t3.micro）
- **ドメイン**: 設定されたドメイン名
- **アクセス**: インターネットから直接アクセス可能

### 検証環境
- **サーバー**: 検証用EC2（通常は停止状態）
- **データベース**: 検証用RDS（本番データのコピー）
- **アクセス**: NAT経由でのみアクセス可能

---

## 基本的な運用手順

### 1. 環境情報の確認

```bash
# 現在の環境情報を確認
terraform output

# 本番環境のIPアドレス
terraform output -raw wordpress_public_ip

# 検証環境のIPアドレス
terraform output -raw validation_private_ip
```

### 2. WordPress管理画面へのアクセス

1. **本番環境**: `http://[本番IP]/wp-admin`
2. **検証環境**: `http://[検証IP]/wp-admin`

### 3. 日常的な確認事項

- [ ] サイトが正常に表示されるか
- [ ] 管理画面にログインできるか
- [ ] 新規投稿が作成できるか
- [ ] コメントが正常に表示されるか

---

## 記事更新手順

### 手順1: 検証環境の準備

```bash
# 自動デプロイメントスクリプトを実行
./scripts/auto_deployment.sh
```

**実行される処理:**
- 本番環境のスナップショット作成
- 検証環境の起動（スナップショットから復元）
- 検証環境の準備完了待機
- 基本的な動作確認

### 手順2: 検証環境での記事作成・テスト

1. **検証環境にアクセス**
   ```bash
   # 検証環境への接続
   ./connect_validation.sh
   ```

2. **WordPress管理画面へのログイン**
   - ブラウザで `http://[検証環境IP]/wp-admin` にアクセス
   - ユーザー名とパスワードでログイン

3. **新しい記事の作成**
   - **ダッシュボード** → **投稿** → **新規追加**
   - タイトルと内容を入力
   - カテゴリーとタグを設定
   - **下書き保存** を選択

4. **記事のプレビューとテスト**
   - **プレビュー** ボタンをクリック
   - 記事が正常に表示されることを確認
   - 画像やリンクが正しく表示されることを確認
   - レスポンシブデザインの確認

5. **追加機能のテスト**
   - プラグインのテスト（Yoast SEO、ソーシャルメディア共有など）
   - テーマの確認（表示、サイドバー、フッター）
   - パフォーマンステスト

### 手順3: 本番環境への反映

**重要**: 検証環境で問題がないことを確認してから実行

1. **デプロイメントの実行**
   ```bash
   # デプロイメントの確認
   echo "検証環境でのテストが完了しました。本番環境への反映を続行しますか？ (y/N)"
   read -r response
   if [[ "$response" =~ ^[Yy]$ ]]; then
       echo "デプロイメントを続行します..."
   else
       echo "デプロイメントを中止しました"
       exit 0
   fi
   ```

2. **デプロイメントプロセス**
   - 本番環境のバックアップ作成
   - 検証環境から本番環境へのデータ同期
   - WordPressファイルの同期
   - 本番環境の動作確認

3. **本番環境での確認**
   - 本番サイトで新しい記事が表示されることを確認
   - 管理画面で記事が正常に投稿されていることを確認

### 手順4: 検証環境の停止

```bash
# 検証環境の停止（自動で実行される）
aws ec2 stop-instances --instance-ids [検証用EC2のID]
aws rds stop-db-instance --db-instance-identifier wp-shamo-rds-validation
```

---

## トラブルシューティング

### よくある問題と対処法

#### 1. サイトにアクセスできない

**確認事項:**
- EC2インスタンスが起動しているか
- セキュリティグループの設定
- ドメインのDNS設定

**対処法:**
```bash
# インスタンスの状態確認
aws ec2 describe-instances --instance-ids [インスタンスID]

# セキュリティグループの確認
aws ec2 describe-security-groups --group-ids [セキュリティグループID]
```

#### 2. WordPress管理画面にログインできない

**確認事項:**
- ユーザー名とパスワードが正しいか
- データベース接続が正常か

**対処法:**
```bash
# データベース接続テスト
mysql -h [RDSエンドポイント] -u [ユーザー名] -p
```

#### 3. 検証環境にアクセスできない

**対処法:**
```bash
# 検証環境の状態確認
aws ec2 describe-instances --instance-ids [検証用EC2のID]

# NATインスタンスの状態確認
aws ec2 describe-instances --instance-ids [NATインスタンスID]
```

#### 4. 記事が本番環境に反映されない

**対処法:**
```bash
# データベース接続の確認
mysql -h [本番RDSエンドポイント] -u admin -p -e "USE wordpress; SELECT * FROM wp_posts WHERE post_status='publish' ORDER BY post_date DESC LIMIT 5;"
```

### ログの確認

```bash
# WordPress EC2のログ確認
./check_userdata_logs.sh

# システムログの確認
ssh ec2-user@[本番IP] "sudo journalctl -f"
```

### 緊急時のロールバック

```bash
# ロールバックの実行
./scripts/rollback.sh
```

---

## 定期メンテナンス

### 毎日の確認
- [ ] サイトの動作確認
- [ ] エラーログの確認
- [ ] バックアップの確認

### 毎週の確認
- [ ] WordPressの更新確認
- [ ] プラグインの更新確認
- [ ] セキュリティスキャン

### 毎月の確認
- [ ] パフォーマンスの確認
- [ ] ストレージ使用量の確認
- [ ] コストの確認

---

## 注意事項

1. **必ず検証環境でテストしてから本番環境に反映**
2. **変更前には必ずバックアップを取得**
3. **緊急時以外は営業時間内に作業を実施**
4. **すべての変更は記録を残す**
5. **セキュリティを最優先に考慮**

---

*この手順書は随時更新されます。最新版を確認してから作業を開始してください。* 