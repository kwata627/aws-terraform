# 検証環境運用ガイド

## 目次
1. [概要](#概要)
2. [設計方針](#設計方針)
3. [運用フロー](#運用フロー)
4. [コスト分析](#コスト分析)
5. [セキュリティ考慮事項](#セキュリティ考慮事項)
6. [運用ベストプラクティス](#運用ベストプラクティス)
7. [トラブルシューティング](#トラブルシューティング)
8. [自動化スクリプト](#自動化スクリプト)
9. [定期メンテナンス](#定期メンテナンス)
10. [セキュリティガイドライン](#セキュリティガイドライン)

---

## 概要

このガイドは、WordPress検証環境の運用方針とベストプラクティスを説明します。コスト削減とセキュリティを考慮した運用方法を提案します。

### 検証環境の目的
- **安全なテスト**: 本番環境に影響を与えずに変更をテスト
- **コスト最適化**: 必要な時だけ起動してコストを削減
- **セキュリティ強化**: 不要時は停止してセキュリティリスクを軽減
- **品質保証**: 本番環境と同一の状態でのテスト

---

## 設計方針

### 基本原則
- **必要な時だけ起動**: コスト削減のため、使用時のみ起動
- **本番環境と同一の状態**: スナップショットから復元して同一性を保証
- **セキュリティ優先**: 不要時は停止してセキュリティリスクを軽減
- **自動化**: 手動操作を最小限に抑えた自動化

### 現在の設定
```hcl
# terraform.tfvars
enable_validation_ec2 = true    # 検証用EC2（停止状態で作成）
enable_validation_rds = false   # 検証用RDS（停止状態で作成）
```

### ネットワーク構成
- **プライベートサブネット**: 外部からの直接アクセス不可
- **NAT経由アクセス**: 制限されたアクセス
- **セキュリティグループ**: 最小権限の設定
- **VPC**: 分離されたネットワーク環境

---

## 運用フロー

### 1. 通常時（停止状態）
```
検証環境EC2: 停止中
検証環境RDS: 停止中
コスト: 最小限（ストレージ料金のみ）
セキュリティ: 外部アクセス完全遮断
監視: 定期的な状態確認
```

### 2. 使用時（起動状態）
```
検証環境EC2: 起動中
検証環境RDS: 起動中（スナップショットから復元）
コスト: 約$25-30/月
セキュリティ: NAT経由での制限されたアクセス
監視: リアルタイム監視
```

### 3. 使用後（停止状態）
```
検証環境EC2: 停止
検証環境RDS: 停止
コスト: 最小限に戻る
セキュリティ: 外部アクセス完全遮断
クリーンアップ: 一時ファイルの削除
```

---

## コスト分析

### 停止時のコスト
- **EC2**: $0/月（停止中は課金なし）
- **RDS**: $0/月（停止中は課金なし）
- **EBS**: 約$1/月（8GB GP2）
- **合計**: 約$1/月

### 起動時のコスト
- **EC2 t2.micro**: 約$8-10/月
- **RDS db.t3.micro**: 約$15-20/月
- **EBS**: 約$1/月
- **合計**: 約$25-30/月

### コスト削減効果
- **月間使用時間**: 10時間/月と仮定
- **従来の常時起動**: $25-30/月
- **現在の運用**: 約$1/月
- **削減効果**: 約$24-29/月（96-97%削減）

### 年間コスト比較
| 運用方式 | 年間コスト | 削減効果 |
|---------|-----------|---------|
| 常時起動 | $300-360 | - |
| 必要時起動 | $12 | $288-348 |

### コスト最適化のポイント
- **使用時間の最小化**: 必要な時だけ起動
- **自動停止**: 使用後は自動的に停止
- **リソース最適化**: 必要最小限のリソース使用
- **監視**: コストの定期的な確認

---

## セキュリティ考慮事項

### 停止時のセキュリティ
- **外部アクセス**: 完全に遮断
- **攻撃対象**: 最小限
- **データ漏洩リスク**: 極めて低い
- **セキュリティパッチ**: 不要（停止中）

### 起動時のセキュリティ
- **プライベートサブネット**: 外部からの直接アクセス不可
- **NAT経由アクセス**: 制限されたアクセス
- **セキュリティグループ**: 最小権限の設定
- **データ暗号化**: 転送時・保存時の暗号化
- **監査ログ**: すべてのアクセスの記録

### セキュリティベストプラクティス
1. **最小権限の原則**: 必要最小限の権限のみ付与
2. **定期的なセキュリティ更新**: 起動時に最新パッチを適用
3. **アクセスログの監視**: すべてのアクセスを記録
4. **脆弱性スキャン**: 定期的なセキュリティチェック
5. **暗号化**: データの暗号化（転送時・保存時）
6. **監査**: 定期的なセキュリティ監査

---

## 運用ベストプラクティス

### 1. 起動タイミング
- **記事更新時**: 新しいコンテンツのテスト
- **プラグイン更新時**: 新機能のテスト
- **テーマ変更時**: デザインの確認
- **WordPress更新時**: 互換性の確認
- **セキュリティテスト時**: 脆弱性の確認
- **パフォーマンステスト時**: 最適化の確認

### 2. 停止タイミング
- **テスト完了後**: 即座に停止
- **作業終了後**: 自動停止スクリプト使用
- **定期メンテナンス**: 月1回の確認
- **緊急時**: 問題発生時の即座停止

### 3. 監視とアラート
```bash
# 起動中のインスタンス確認
aws ec2 describe-instances --filters "Name=instance-state-name,Values=running" --query 'Reservations[].Instances[?contains(Tags[?Key==`Name`].Value, `validation`)]'

# 起動中のRDS確認
aws rds describe-db-instances --query 'DBInstances[?contains(DBInstanceIdentifier, `validation`) && DBInstanceStatus==`available`]'

# コスト監視
aws ce get-cost-and-usage --time-period Start=2024-01-01,End=2024-01-31 --granularity MONTHLY --metrics BlendedCost

# セキュリティイベント監視
aws logs describe-log-groups --log-group-name-prefix "/aws/wordpress"
```

### 4. データ管理
- **スナップショットの管理**: 古いスナップショットは削除
- **バックアップの確認**: 重要なデータは別途バックアップ
- **ストレージ最適化**: 不要なファイルの削除
- **データ整合性**: 本番環境との同期確認

### 5. 自動化
- **自動起動**: 必要な時だけ自動起動
- **自動停止**: 使用後は自動停止
- **自動バックアップ**: 定期的なバックアップ
- **自動監視**: リアルタイム監視

---

## トラブルシューティング

### よくある問題

#### 1. 検証環境が起動しない
```bash
# インスタンスの状態確認
aws ec2 describe-instances --instance-ids [検証用EC2のID]

# エラーログの確認
aws ec2 get-console-output --instance-id [検証用EC2のID]

# セキュリティグループの確認
aws ec2 describe-security-groups --group-ids [セキュリティグループID]

# ネットワーク接続の確認
aws ec2 describe-network-interfaces --filters "Name=attachment.instance-id,Values=[検証用EC2のID]"
```

#### 2. スナップショットから復元できない
```bash
# 利用可能なスナップショット確認
aws rds describe-db-snapshots --db-instance-identifier wp-example-rds

# 手動でスナップショット作成
aws rds create-db-snapshot --db-instance-identifier wp-example-rds --db-snapshot-identifier manual-snapshot-$(date +%Y%m%d)

# スナップショットの状態確認
aws rds describe-db-snapshots --db-snapshot-identifier [スナップショットID]

# 復元プロセスの確認
aws rds describe-db-instances --db-instance-identifier wp-example-rds-validation
```

#### 3. 接続できない
```bash
# NATインスタンスの状態確認
aws ec2 describe-instances --instance-ids [NATインスタンスID]

# ルートテーブルの確認
aws ec2 describe-route-tables --filters "Name=vpc-id,Values=[VPC_ID]"

# ネットワークACLの確認
aws ec2 describe-network-acls --filters "Name=vpc-id,Values=[VPC_ID]"

# セキュリティグループの確認
aws ec2 describe-security-groups --group-ids [セキュリティグループID]
```

#### 4. パフォーマンスの問題
```bash
# EC2インスタンスのメトリクス確認
aws cloudwatch get-metric-statistics --namespace AWS/EC2 --metric-name CPUUtilization --dimensions Name=InstanceId,Value=[インスタンスID] --start-time 2024-01-01T00:00:00Z --end-time 2024-01-01T23:59:59Z --period 3600 --statistics Average

# RDSインスタンスのメトリクス確認
aws cloudwatch get-metric-statistics --namespace AWS/RDS --metric-name CPUUtilization --dimensions Name=DBInstanceIdentifier,Value=wp-shamo-rds-validation --start-time 2024-01-01T00:00:00Z --end-time 2024-01-01T23:59:59Z --period 3600 --statistics Average

# ネットワークパフォーマンスの確認
aws cloudwatch get-metric-statistics --namespace AWS/EC2 --metric-name NetworkIn --dimensions Name=InstanceId,Value=[インスタンスID] --start-time 2024-01-01T00:00:00Z --end-time 2024-01-01T23:59:59Z --period 3600 --statistics Average
```

#### 5. セキュリティの問題
```bash
# セキュリティグループの確認
aws ec2 describe-security-groups --group-ids [セキュリティグループID]

# ネットワークACLの確認
aws ec2 describe-network-acls --filters "Name=vpc-id,Values=[VPC_ID]"

# アクセスログの確認
aws logs describe-log-groups --log-group-name-prefix "/aws/wordpress"

# セキュリティイベントの確認
aws guardduty list-findings --detector-id [DetectorID]
```

---

## 自動化スクリプト

### 起動スクリプト
```bash
#!/bin/bash
# scripts/deployment/prepare_validation.sh
echo "検証環境を起動中..."
aws ec2 start-instances --instance-ids [検証用EC2のID]
aws rds start-db-instance --db-instance-identifier wp-example-rds-validation
echo "起動完了。準備完了まで数分お待ちください。"
```

### 停止スクリプト
```bash
#!/bin/bash
# scripts/maintenance/stop_validation.sh
echo "検証環境を停止中..."
aws ec2 stop-instances --instance-ids [検証用EC2のID]
aws rds stop-db-instance --db-instance-identifier wp-example-rds-validation
echo "停止完了。"
```

### 監視スクリプト
```bash
#!/bin/bash
# scripts/maintenance/check_validation_status.sh
echo "検証環境の状態を確認中..."

# EC2インスタンスの状態確認
EC2_STATUS=$(aws ec2 describe-instances --instance-ids [検証用EC2のID] --query 'Reservations[0].Instances[0].State.Name' --output text)

# RDSインスタンスの状態確認
RDS_STATUS=$(aws rds describe-db-instances --db-instance-identifier wp-example-rds-validation --query 'DBInstances[0].DBInstanceStatus' --output text)

echo "EC2状態: $EC2_STATUS"
echo "RDS状態: $RDS_STATUS"

# 起動中の場合は警告
if [[ "$EC2_STATUS" == "running" || "$RDS_STATUS" == "available" ]]; then
    echo "警告: 検証環境が起動中です。作業完了後は停止してください。"
fi
```

### コスト監視スクリプト
```bash
#!/bin/bash
# scripts/maintenance/check_costs.sh
echo "検証環境のコストを確認中..."

# 月間コストの確認
MONTHLY_COST=$(aws ce get-cost-and-usage --time-period Start=$(date -d '1 month ago' +%Y-%m-%d),End=$(date +%Y-%m-%d) --granularity MONTHLY --metrics BlendedCost --query 'ResultsByTime[0].Total.BlendedCost.Amount' --output text)

echo "月間コスト: $MONTHLY_COST USD"

# コストが高い場合は警告
if (( $(echo "$MONTHLY_COST > 30" | bc -l) )); then
    echo "警告: 月間コストが30USDを超えています。検証環境の使用状況を確認してください。"
fi
```

---

## 定期メンテナンス

### 毎週の確認
- [ ] 不要なスナップショットの削除
- [ ] 起動中の検証環境の確認
- [ ] コストレポートの確認
- [ ] セキュリティログの確認
- [ ] パフォーマンスの確認

### 毎月の確認
- [ ] 使用頻度の分析
- [ ] 設定の最適化
- [ ] セキュリティ設定の見直し
- [ ] パフォーマンスの確認
- [ ] コストの詳細分析

### 四半期の確認
- [ ] 運用方針の見直し
- [ ] コスト最適化の検討
- [ ] セキュリティ監査
- [ ] 自動化スクリプトの更新
- [ ] ドキュメントの更新

---

## セキュリティガイドライン

### 1. アクセス制御
- **SSH接続**: 特定IPからのみ許可
- **管理画面**: 強力なパスワードの使用
- **データベース**: 最小権限の原則
- **ネットワーク**: プライベートサブネットの使用

### 2. データ保護
- **暗号化**: 転送時・保存時の暗号化
- **バックアップ**: 自動バックアップの確認
- **監査ログ**: すべての操作の記録
- **データ整合性**: 本番環境との同期確認

### 3. セキュリティ監視
- **CloudWatch**: セキュリティイベントの監視
- **GuardDuty**: 脅威検出
- **WAF**: Webアプリケーションファイアウォール
- **VPC Flow Logs**: ネットワークトラフィックの監視

### 4. インシデント対応
- **問題検出**: 迅速な問題検出
- **対応手順**: 明確な対応手順
- **復旧手順**: データ復旧の手順
- **報告体制**: 問題報告の体制

---

## 運用チェックリスト

### 起動前の確認
- [ ] 作業内容の明確化
- [ ] 必要な時間の見積もり
- [ ] バックアップの確認
- [ ] セキュリティ設定の確認
- [ ] コストの確認

### 起動後の確認
- [ ] インスタンスの正常起動
- [ ] データベースの正常起動
- [ ] ネットワーク接続の確認
- [ ] WordPressサイトの動作確認
- [ ] セキュリティ設定の確認

### 作業中の確認
- [ ] 定期的な進捗確認
- [ ] エラーログの監視
- [ ] パフォーマンスの確認
- [ ] セキュリティの確認
- [ ] コストの監視

### 停止前の確認
- [ ] 作業内容の完了確認
- [ ] データの保存確認
- [ ] ログの確認
- [ ] セキュリティの確認
- [ ] クリーンアップの実行

### 停止後の確認
- [ ] インスタンスの正常停止
- [ ] コストの確認
- [ ] ログの保存
- [ ] 次回作業の計画
- [ ] ドキュメントの更新

---

## 注意事項

1. **起動後は必ず停止**: コスト削減のため
2. **スナップショットの管理**: 古いスナップショットは削除
3. **セキュリティの確認**: 起動時のアクセス制御を確認
4. **ログの監視**: エラーログを定期的に確認
5. **バックアップの確認**: 重要なデータは別途バックアップ
6. **緊急時の対応**: 問題発生時の迅速な対応手順を確認
7. **コストの監視**: 定期的なコスト確認
8. **セキュリティ監査**: 定期的なセキュリティ監査の実施

---

*このガイドは随時更新されます。最新版を確認してから運用してください。* 