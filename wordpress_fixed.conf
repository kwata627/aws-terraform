# WordPress用Apache設定
# サブドメイン完全分離型設定

# 1. メインサイト HTTP → HTTPS リダイレクト
<VirtualHost *:80>
    ServerName shamolife.com
    Redirect permanent / https://shamolife.com/
</VirtualHost>

# 2. 管理画面 HTTP → HTTPS リダイレクト
<VirtualHost *:80>
    ServerName admin.shamolife.com
    Redirect permanent / https://admin.shamolife.com/
</VirtualHost>

# 3. 管理画面 HTTPS（より具体的なドメインを先に定義）
<VirtualHost *:443>
    ServerName admin.shamolife.com
    DocumentRoot /var/www/html
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/shamolife.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/shamolife.com/privkey.pem

    # クライアントリクエストサイズ制限（管理画面はより大きな制限）
    LimitRequestBody 5368709120
    LimitRequestFieldSize 16384
    LimitRequestLine 8190

    # PHP-FPM設定
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
    </FilesMatch>

    <Directory /var/www/html>
        AllowOverride All
        Require all granted
        Options Indexes FollowSymLinks
    </Directory>

    # 管理画面へのリダイレクト設定
    RewriteEngine On
    RewriteCond %{REQUEST_URI} ^/$
    RewriteRule ^/?$ /wp-admin/ [R=302,L]

    # 管理画面ディレクトリへのアクセスを許可
    <Directory "/var/www/html/wp-admin">
        Require all granted
    </Directory>

    # ログインページへのアクセスを許可
    <Location /wp-login.php>
        Require all granted
    </Location>

    # セキュリティヘッダー
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options SAMEORIGIN
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; img-src 'self' data: https:; frame-src 'self'; object-src 'none';"
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    </IfModule>

    # ログ設定
    ErrorLog logs/wordpress_admin_error.log
    CustomLog logs/wordpress_admin_access.log combined
</VirtualHost>

# 4. 公開サイト HTTPS（デフォルト）
<VirtualHost *:443>
    ServerName shamolife.com
    DocumentRoot /var/www/html
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/shamolife.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/shamolife.com/privkey.pem

    # クライアントリクエストサイズ制限
    LimitRequestBody 5368709120
    LimitRequestFieldSize 16384
    LimitRequestLine 8190

    # PHP-FPM設定
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"
    </FilesMatch>

    <Directory /var/www/html>
        AllowOverride All
        Require all granted
        Options Indexes FollowSymLinks
    </Directory>

    # 公開サイトから管理画面へのアクセスを完全に拒否
    <Directory "/var/www/html/wp-admin">
        Require all denied
    </Directory>

    <Location /wp-login.php>
        Require all denied
    </Location>

    # セキュリティヘッダー
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options SAMEORIGIN
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; img-src 'self' data: https:; frame-src 'self'; object-src 'none';"
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    </IfModule>

    # ログ設定
    ErrorLog logs/wordpress_error.log
    CustomLog logs/wordpress_access.log combined
</VirtualHost>
