# Scripts ディレクトリ - スクリプト説明書

## 概要

このディレクトリには、WordPress環境の自動デプロイメントと運用に必要なスクリプトが含まれています。各スクリプトは特定の目的を持ち、安全な運用を実現します。

## スクリプト一覧（運用順序）

### 1. `setup_deployment.sh` - 初期設定スクリプト

#### いつ使うか
- **初回セットアップ時**: システムを初めて使用する時
- **新しい環境に移行する時**: 別のサーバーや環境に移行する時
- **設定ファイルが壊れた時**: 設定に問題がある時

#### なぜ必要か
- 必要なツールがインストールされていないと、他のスクリプトが動かない
- 設定ファイルがないと、システムがどのサーバーを操作すべきかわからない
- SSH鍵がないと、サーバーに接続できない

#### 何をするか
1. **必要なツールの確認・インストール**
   - jq（JSONパーサー）: 設定ファイルを読み込むため
   - AWS CLI: AWSのサーバーを操作するため
   - MySQLクライアント: データベースを操作するため

2. **設定ファイルの作成**
   - `deployment_config.json`のテンプレート作成
   - 設定項目の説明表示

3. **SSH鍵の設定**
   - Terraformの出力からSSH鍵を取得
   - 適切な権限で設定

4. **AWS認証情報の確認**
   - AWS認証情報が設定されているか確認
   - 設定されていない場合の指示表示

5. **実行権限の付与**
   - すべてのスクリプトに実行権限を付与

6. **テストスクリプトの作成**
   - `test_deployment.sh`の作成
   - 環境テスト用スクリプト

#### 何が起こるか
- 必要なツールが自動でインストールされる
- 設定ファイルのテンプレートが作成される
- SSH鍵が自動で設定される
- すべてのスクリプトが実行可能になる

#### 使用方法
```bash
# 初期設定の実行（最初に実行）
./scripts/setup_deployment.sh

# 設定後の確認
./scripts/test_deployment.sh
```

#### 設定項目
初期設定後に`deployment_config.json`で設定が必要：
- 本番EC2インスタンスID
- 本番WordPressサイトのURL
- 検証EC2インスタンスID
- 検証WordPressサイトのURL
- 通知メールアドレス（オプション）

### 2. `prepare_validation.sh` - 検証環境準備スクリプト

#### いつ使うか
- **記事を更新する前**: 新しい記事を投稿する前
- **プラグインを更新する前**: 新しい機能を追加する前
- **テーマを変更する前**: デザインを変更する前
- **WordPressを更新する前**: システムを更新する前

#### なぜ必要か
- 本番環境を直接変更すると、問題が起きた時にサイトが使えなくなる
- 検証環境でテストすることで、安全に変更を確認できる
- 本番環境と同じ状態でテストできる

#### 何をするか
1. **本番環境のスナップショット作成**
   - 本番RDSのスナップショットを自動作成
   - タイムスタンプ付きで識別

2. **検証環境の起動**
   - 検証用EC2インスタンスを起動
   - スナップショットから検証用RDSを復元

3. **検証環境の準備完了待機**
   - EC2インスタンスの起動完了を待機
   - RDSインスタンスの利用可能状態を待機

4. **検証環境でのテスト実行**
   - WordPressサイトの動作確認
   - 管理画面のアクセス確認
   - データベース接続確認

#### 何が起こるか
- 本番環境のデータがコピーされた検証環境が起動する
- 検証環境で安全にテストができるようになる
- 本番環境には一切影響しない

#### 使用方法
```bash
# 検証環境の準備実行
./scripts/prepare_validation.sh

# 検証環境の情報確認
tail -f prepare_validation_*.log
```

#### 検証環境でのテスト
準備完了後、検証環境で以下のテストを実行：
- WordPress管理画面での記事作成・編集
- プラグインの更新・設定
- テーマの変更・カスタマイズ
- 新機能の動作確認

### 3. `deploy_to_production.sh` - 本番環境反映スクリプト

#### いつ使うか
- **検証環境でのテストが完了した時**: 問題がないことを確認した後
- **記事を本番に反映する時**: 検証環境で作成した記事を公開する時
- **プラグインの更新を反映する時**: 新機能を本番環境に適用する時

#### なぜ必要か
- 検証環境の変更を本番環境に反映する必要がある
- 手動でコピーすると間違いが起きる可能性がある
- 自動化することで安全で確実な反映ができる

#### 何をするか
1. **検証環境の状態確認**
   - 検証環境が起動しているか確認
   - 準備スクリプトの実行を確認

2. **ユーザー確認**
   - 自動承認でない場合、ユーザーの確認を求める
   - 確認後、本番環境への反映を実行

3. **本番環境のバックアップ作成**
   - 本番環境のデータベースバックアップ
   - WordPressファイルのバックアップ

4. **検証環境から本番環境へのデータ同期**
   - データベースの同期
   - WordPressファイルの同期

5. **本番環境の動作確認**
   - サイトの動作確認
   - 管理画面のアクセス確認

6. **検証環境の停止**
   - 検証用EC2インスタンスの停止
   - 検証用RDSインスタンスの停止

7. **クリーンアップ**
   - 一時ファイルの削除
   - ログファイルの保存

#### 何が起こるか
- 検証環境の変更が本番環境に反映される
- 本番サイトが一時的に停止する可能性がある
- 検証環境が自動で停止してコストが削減される

#### 使用方法
```bash
# 本番環境への反映実行
./scripts/deploy_to_production.sh

# 反映ログの確認
tail -f deploy_to_production_*.log
```

#### 注意事項
- 検証環境でのテスト完了後に実行
- 本番環境が一時的に停止する可能性
- バックアップが自動的に作成される

### 4. `rollback.sh` - ロールバックスクリプト

#### いつ使うか
- **デプロイメントが失敗した時**: 本番環境に問題が起きた時
- **サイトが表示されなくなった時**: エラーが発生した時
- **緊急時に元に戻したい時**: すぐに復旧が必要な時

#### なぜ必要か
- 問題が起きた時に素早く元の状態に戻す必要がある
- 手動で復旧すると時間がかかりすぎる
- 自動化することで迅速な復旧ができる

#### 何をするか
1. **最新スナップショットの取得**
   - 本番RDSの最新スナップショットを自動検出

2. **本番環境の停止**
   - 本番RDSインスタンスを停止

3. **スナップショットからの復元**
   - 最新スナップショットから本番RDSを復元

4. **復元完了待機**
   - RDSインスタンスの利用可能状態を待機

5. **WordPressファイルの復元**
   - 最新のバックアップファイルから復元
   - ファイル権限の設定

6. **動作確認**
   - 復元後のサイト動作確認

#### 何が起こるか
- 本番環境が最新のスナップショットの状態に戻る
- 本番サイトが一時的に停止する
- 問題が解決されてサイトが正常に動作するようになる

#### 使用方法
```bash
# ロールバックの実行（緊急時のみ）
./scripts/rollback.sh

# ロールバックログの確認
tail -f rollback_*.log
```

#### 注意事項
- 最新のスナップショットを使用
- 本番環境が一時的に停止する
- 復元に時間がかかる場合がある

### 5. `auto_deployment.sh` - 自動デプロイメントスクリプト

#### いつ使うか
- **一連の作業を自動化したい時**: 検証環境準備から本番反映まで
- **定期的な更新作業時**: 毎週の記事更新など
- **複数の変更を一度に反映する時**: 大きな更新作業時

#### なぜ必要か
- 手動で一つずつ実行すると時間がかかる
- 自動化することで効率的に作業できる
- ミスを減らすことができる

#### 何をするか
1. **検証環境の準備**: `prepare_validation.sh`を実行
2. **ユーザー確認**: 検証環境でのテスト完了を確認
3. **本番環境への反映**: `deploy_to_production.sh`を実行
4. **完了確認**: すべての作業が正常に完了したか確認

#### 何が起こるか
- 検証環境の準備から本番反映まで自動で実行される
- 途中で確認が必要な場合は停止する
- すべての作業がログに記録される

#### 使用方法
```bash
# 自動デプロイメントの実行
./scripts/auto_deployment.sh
```

## 運用フロー

### 基本的な運用順序
```bash
# 1. 初期設定（初回のみ）
./scripts/setup_deployment.sh

# 2. 設定ファイルの編集
# deployment_config.json を編集

# 3. 環境テスト
./scripts/test_deployment.sh

# 4. 検証環境の準備
./scripts/prepare_validation.sh

# 5. 検証環境でのテスト実行
# ブラウザで検証環境にアクセスしてテスト

# 6. 本番環境への反映
./scripts/deploy_to_production.sh

# 7. 緊急時のみロールバック
./scripts/rollback.sh
```

### 運用シナリオ

#### 初回セットアップ
1. `setup_deployment.sh` で初期設定
2. `deployment_config.json` で環境情報を設定
3. `test_deployment.sh` で環境テスト
4. `prepare_validation.sh` で検証環境準備
5. 検証環境でテスト実行
6. `deploy_to_production.sh` で本番環境反映

#### 日常的な運用
1. `prepare_validation.sh` で検証環境準備
2. 検証環境でテスト実行
3. `deploy_to_production.sh` で本番環境反映
4. 必要に応じて `rollback.sh` でロールバック

#### トラブルシューティング
1. ログファイルの確認
2. 設定ファイルの確認
3. 必要に応じて `rollback.sh` で復旧

## 共通設定
```bash
# AWS認証情報
export AWS_ACCESS_KEY_ID=your_access_key
export AWS_SECRET_ACCESS_KEY=your_secret_key
export AWS_DEFAULT_REGION=ap-northeast-1

# またはAWS CLI設定
aws configure
```

### 必要なツール
- `jq`: JSONパーサー
- `aws`: AWS CLI
- `mysql`: MySQLクライアント
- `curl`: HTTPリクエスト
- `ssh`: SSH接続

### ログファイル
- `deployment_YYYYMMDD_HHMMSS.log`: デプロイメントログ
- `rollback_YYYYMMDD_HHMMSS.log`: ロールバックログ

## トラブルシューティング

### よくある問題

#### 1. AWS認証情報エラー
```bash
# 認証情報の確認
aws sts get-caller-identity

# 認証情報の設定
aws configure
```

#### 2. SSH接続エラー
```bash
# SSH鍵の確認
ls -la ~/.ssh/id_rsa

# SSH鍵の再設定
terraform output -raw ssh_private_key > ~/.ssh/id_rsa
chmod 600 ~/.ssh/id_rsa
```

#### 3. 設定ファイルエラー
```bash
# 設定ファイルの確認
cat deployment_config.json

# 設定ファイルのテンプレート再作成
./scripts/setup_deployment.sh
```

#### 4. 権限エラー
```bash
# 実行権限の付与
chmod +x scripts/*.sh
```

## セキュリティ考慮事項

### 1. アクセス制御
- AWS認証情報の適切な管理
- SSH鍵の安全な保管
- 最小権限の原則に従ったIAM設定

### 2. データ保護
- 自動バックアップの作成
- スナップショットの暗号化
- 機密情報の適切な管理

### 3. 監査ログ
- すべての操作のログ記録
- 変更履歴の追跡
- アクセスログの監視

## ベストプラクティス

### 1. デプロイメント前の確認
- 設定ファイルの内容確認
- 環境テストの実行
- バックアップの確認

### 2. 段階的なデプロイメント
- 小さな変更から開始
- 各段階での動作確認
- 問題発生時の迅速な対応

### 3. 監視とアラート
- デプロイメント後の監視
- パフォーマンスの確認
- エラーアラートの設定

### 4. ドキュメント管理
- 変更履歴の記録
- 設定変更の記録
- トラブルシューティングの記録

---

## 注意事項

1. **必ず検証環境でテストしてから本番環境に反映**
2. **デプロイメント前のバックアップ確認**
3. **緊急時以外は営業時間内に実行**
4. **すべての操作のログ記録**
5. **セキュリティを最優先に考慮**

---

*このドキュメントは随時更新されます。最新版を確認してから作業を開始してください。* 