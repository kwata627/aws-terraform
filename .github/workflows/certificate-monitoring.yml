name: Certificate Monitoring

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      domain_name:
        description: 'ç›£è¦–ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³å'
        required: false
        default: ''
      certificate_arn:
        description: 'è¨¼æ˜æ›¸ARN'
        required: false
        default: ''

jobs:
  certificate-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1  # ACMè¨¼æ˜æ›¸ã¯us-east-1ã«ã‚ã‚Šã¾ã™
          
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          
      - name: Initialize Terraform
        run: |
          terraform init
          
      - name: Get certificate information
        id: get-cert-info
        run: |
          # Terraformå‡ºåŠ›ã‹ã‚‰è¨¼æ˜æ›¸æƒ…å ±ã‚’å–å¾—
          CERT_ARN=$(terraform output -raw acm_certificate_arn 2>/dev/null || echo "")
          DOMAIN_NAME=$(terraform output -raw acm_certificate_domain_name 2>/dev/null || echo "")
          
          # æ‰‹å‹•å…¥åŠ›ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ã
          if [ -n "${{ github.event.inputs.certificate_arn }}" ]; then
            CERT_ARN="${{ github.event.inputs.certificate_arn }}"
          fi
          if [ -n "${{ github.event.inputs.domain_name }}" ]; then
            DOMAIN_NAME="${{ github.event.inputs.domain_name }}"
          fi
          
          echo "cert_arn=$CERT_ARN" >> $GITHUB_OUTPUT
          echo "domain_name=$DOMAIN_NAME" >> $GITHUB_OUTPUT
          
          if [ -z "$CERT_ARN" ]; then
            echo "ERROR: è¨¼æ˜æ›¸ARNã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
          if [ -z "$DOMAIN_NAME" ]; then
            echo "ERROR: ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
          
          echo "è¨¼æ˜æ›¸ARN: $CERT_ARN"
          echo "ãƒ‰ãƒ¡ã‚¤ãƒ³å: $DOMAIN_NAME"
          
      - name: Check certificate status
        id: check-cert
        run: |
          CERT_ARN="${{ steps.get-cert-info.outputs.cert_arn }}"
          DOMAIN_NAME="${{ steps.get-cert-info.outputs.domain_name }}"
          
          # è¨¼æ˜æ›¸ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
          CERT_INFO=$(aws acm describe-certificate \
            --certificate-arn "$CERT_ARN" \
            --region us-east-1 \
            --query 'Certificate.{Status:Status,DomainName:DomainName,NotAfter:NotAfter,RenewalEligibility:RenewalEligibility}' \
            --output json)
          
          echo "è¨¼æ˜æ›¸æƒ…å ±: $CERT_INFO"
          
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
          STATUS=$(echo "$CERT_INFO" | jq -r '.Status')
          RENEWAL_ELIGIBILITY=$(echo "$CERT_INFO" | jq -r '.RenewalEligibility')
          NOT_AFTER=$(echo "$CERT_INFO" | jq -r '.NotAfter')
          
          echo "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS"
          echo "æ›´æ–°é©æ ¼æ€§: $RENEWAL_ELIGIBILITY"
          echo "æœ‰åŠ¹æœŸé™: $NOT_AFTER"
          
          # æœ‰åŠ¹æœŸé™ã¾ã§ã®æ—¥æ•°ã‚’è¨ˆç®—
          CURRENT_DATE=$(date +%s)
          EXPIRY_DATE=$(date -d "$NOT_AFTER" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S%z" "$NOT_AFTER" +%s 2>/dev/null)
          DAYS_UNTIL_EXPIRY=$(( (EXPIRY_DATE - CURRENT_DATE) / 86400 ))
          
          echo "æœ‰åŠ¹æœŸé™ã¾ã§: $DAYS_UNTIL_EXPIRY æ—¥"
          
          # çµæœã‚’å‡ºåŠ›
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "renewal_eligibility=$RENEWAL_ELIGIBILITY" >> $GITHUB_OUTPUT
          echo "days_until_expiry=$DAYS_UNTIL_EXPIRY" >> $GITHUB_OUTPUT
          echo "not_after=$NOT_AFTER" >> $GITHUB_OUTPUT
          
          # ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶ã®ãƒã‚§ãƒƒã‚¯
          ALERT_NEEDED=false
          ALERT_MESSAGE=""
          
          if [ "$STATUS" != "ISSUED" ]; then
            ALERT_NEEDED=true
            ALERT_MESSAGE="è¨¼æ˜æ›¸ãŒç™ºè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUSï¼‰"
          elif [ "$RENEWAL_ELIGIBILITY" != "ELIGIBLE" ]; then
            ALERT_NEEDED=true
            ALERT_MESSAGE="è¨¼æ˜æ›¸ã®è‡ªå‹•æ›´æ–°ãŒé©æ ¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆ$RENEWAL_ELIGIBILITYï¼‰"
          elif [ "$DAYS_UNTIL_EXPIRY" -le 0 ]; then
            ALERT_NEEDED=true
            ALERT_MESSAGE="è¨¼æ˜æ›¸ãŒæœŸé™åˆ‡ã‚Œã§ã™ï¼"
          elif [ "$DAYS_UNTIL_EXPIRY" -le 30 ]; then
            ALERT_NEEDED=true
            ALERT_MESSAGE="è¨¼æ˜æ›¸ã®æœ‰åŠ¹æœŸé™ãŒ30æ—¥ä»¥å†…ã§ã™ï¼ˆæ®‹ã‚Š $DAYS_UNTIL_EXPIRY æ—¥ï¼‰"
          fi
          
          echo "alert_needed=$ALERT_NEEDED" >> $GITHUB_OUTPUT
          echo "alert_message=$ALERT_MESSAGE" >> $GITHUB_OUTPUT
          
      - name: Send alert notification
        if: steps.check-cert.outputs.alert_needed == 'true'
        run: |
          ALERT_MESSAGE="${{ steps.check-cert.outputs.alert_message }}"
          DOMAIN_NAME="${{ steps.get-cert-info.outputs.domain_name }}"
          DAYS_UNTIL_EXPIRY="${{ steps.check-cert.outputs.days_until_expiry }}"
          
          echo "ğŸš¨ SSLè¨¼æ˜æ›¸ã‚¢ãƒ©ãƒ¼ãƒˆ ğŸš¨"
          echo "ãƒ‰ãƒ¡ã‚¤ãƒ³: $DOMAIN_NAME"
          echo "å•é¡Œ: $ALERT_MESSAGE"
          echo "æœ‰åŠ¹æœŸé™ã¾ã§: $DAYS_UNTIL_EXPIRY æ—¥"
          echo ""
          echo "å¯¾å¿œãŒå¿…è¦ã§ã™:"
          echo "1. è¨¼æ˜æ›¸ã®æ›´æ–°çŠ¶æ³ã‚’ç¢ºèª"
          echo "2. DNSæ¤œè¨¼ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç¢ºèª"
          echo "3. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•å¯¾å¿œ"
          
          # ã“ã“ã§Slackã€ãƒ¡ãƒ¼ãƒ«ã€SNSç­‰ã®é€šçŸ¥å‡¦ç†ã‚’è¿½åŠ 
          # ä¾‹: Slacké€šçŸ¥
          # curl -X POST -H 'Content-type: application/json' \
          #   --data "{\"text\":\"ğŸš¨ SSLè¨¼æ˜æ›¸ã‚¢ãƒ©ãƒ¼ãƒˆ: $ALERT_MESSAGE\"}" \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: Upload check results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: certificate-check-results
          path: |
            certificate-renewal-check.log
            terraform_output.json
          retention-days: 30
          
      - name: Create issue for alert
        if: steps.check-cert.outputs.alert_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['certificate-alert']
            });
            
            // åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const existingIssue = issues.find(issue => 
              issue.title.includes('${{ steps.get-cert-info.outputs.domain_name }}')
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸš¨ SSLè¨¼æ˜æ›¸ã‚¢ãƒ©ãƒ¼ãƒˆ: ${{ steps.get-cert-info.outputs.domain_name }}',
                body: 'SSLè¨¼æ˜æ›¸ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
                labels: ['certificate-alert', 'security', 'urgent']
              });
            }
