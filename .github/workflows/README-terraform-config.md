# Terraform Configuration Management

このディレクトリには、Terraform設定管理スクリプトをGitHub Actionsに置き換えたワークフローファイルが含まれています。

## 概要

元の `scripts/setup/terraform_config.sh` スクリプトの機能をGitHub Actionsで実装し、以下の機能を提供します：

- ドメイン名の設定
- スナップショット日付の設定
- SSH許可IPの設定
- 検証環境の設定
- 登録者情報の設定
- 既存ドメインの自動検出
- terraform.tfvarsの生成・更新
- deployment_config.jsonの生成・更新

## ファイル構成

```
.github/workflows/
├── terraform-config.yml                    # Terraform設定管理ワークフロー
├── config/
│   └── deployment-config-template.json     # 設定ファイルテンプレート
└── README-terraform-config.md             # このファイル
```

## 設定

### 1. GitHub Secrets の設定

以下のシークレットをGitHubリポジトリに設定してください：

- `AWS_ACCESS_KEY_ID`: AWSアクセスキーID
- `AWS_SECRET_ACCESS_KEY`: AWSシークレットアクセスキー

### 2. 必要な権限

AWS認証情報には以下の権限が必要です：

- Route53 Domains: ドメイン登録状況の確認
- IAM: 認証情報の確認

## 使用方法

### 1. 手動実行（新規設定）

GitHub Actionsのページから手動でワークフローを実行できます：

1. GitHubリポジトリの「Actions」タブに移動
2. 「Terraform Configuration Management」を選択
3. 「Run workflow」をクリック
4. 以下のパラメータを設定：

#### 必須パラメータ
- **Domain name**: ドメイン名（例: example.com）
- **Snapshot date**: スナップショット日付（例: 20250803）
- **SSH allowed IP**: SSH許可IP（例: 192.168.1.1/32）
- **Registrant name**: 登録者名
- **Registrant email**: 登録者メールアドレス
- **Registrant phone**: 登録者電話番号（例: +81.1234567890）

#### オプションパラメータ
- **Enable validation environment**: 検証環境の有効化
- **Register new domain**: 新規ドメイン登録
- **Update existing configuration only**: 既存設定の更新のみ

### 2. 自動実行

以下の条件でワークフローが自動実行されます：

- `main`ブランチへのプッシュ
- 以下のファイルが変更された場合：
  - `terraform.tfvars`
  - `deployment_config.json`
  - `variables.tf`
  - `main.tf`

### 3. 既存設定の更新

`Update existing configuration only` を `true` に設定すると、既存の設定ファイルのみを更新します。

## ワークフローの流れ

### 1. Terraform設定の検証 (validate-terraform)
- Terraformの初期化
- 設定ファイルの構文チェック
- フォーマットチェック

### 2. 既存ドメインの確認 (check-existing-domain)
- Route53でのドメイン登録状況確認
- 既存ドメインの検出
- 新規登録の判定

### 3. 設定ファイルの生成 (generate-config)
- `terraform.tfvars` の生成
- `deployment_config.json` の生成
- 設定ファイルの検証

### 4. 既存設定の更新 (update-config)
- 既存設定ファイルのバックアップ
- SSH許可IPの更新
- 検証環境設定の更新
- 登録者情報の更新

### 5. 生成された設定の検証 (validate-generated-config)
- Terraformプランの実行
- 設定ファイルの形式検証
- 必須項目の確認

### 6. 変更のコミット (commit-changes)
- 生成された設定ファイルのコミット
- 自動プッシュ

### 7. 完了通知 (notify-completion)
- 設定管理の完了通知
- 実行結果の表示

## 生成されるファイル

### 1. terraform.tfvars

```hcl
# WordPress AWS環境設定
# 生成日時: 2025-01-XX XX:XX:XX
# Generated by GitHub Actions

# ドメイン設定
domain_name = "example.com"
register_domain = false

# スナップショット設定
snapshot_date = "20250803"

# セキュリティ設定
ssh_allowed_ip = "192.168.1.1/32"

# 検証環境設定
validation_enabled = false

# 登録者情報
registrant_name = "John Doe"
registrant_email = "john@example.com"
registrant_phone = "+81.1234567890"
```

### 2. deployment_config.json

```json
{
    "production": {
        "ec2_instance_id": "",
        "rds_identifier": "wp-shamo-rds",
        "wordpress_url": "http://example.com",
        "backup_retention_days": 7
    },
    "validation": {
        "ec2_instance_id": "",
        "rds_identifier": "wp-shamo-rds-validation",
        "wordpress_url": "http://validation-ip",
        "test_timeout_minutes": 30
    },
    "deployment": {
        "auto_approve": false,
        "rollback_on_failure": true
    }
}
```

## エラーハンドリング

### 1. 設定エラー
- Terraform設定ファイルの構文エラー
- 必須項目の欠落
- 無効な値の設定

### 2. AWS操作エラー
- AWS認証情報の不備
- Route53ドメイン確認エラー
- 権限不足エラー

### 3. ファイル生成エラー
- 設定ファイルの生成失敗
- テンプレートファイルの欠落
- 権限エラー

### 4. コミットエラー
- Git設定エラー
- プッシュ権限エラー
- マージコンフリクト

## セキュリティ

### 1. 認証情報管理
- AWS認証情報はGitHub Secretsで管理
- 最小権限の原則に従ったIAMポリシー

### 2. 設定ファイル保護
- 機密情報の暗号化
- バックアップの自動作成
- 変更履歴の追跡

### 3. ドメイン登録
- 既存ドメインの自動検出
- 重複登録の防止
- 料金の事前通知

## トラブルシューティング

### 1. よくあるエラー

#### AWS認証情報エラー
```
Error: AWS認証情報が設定されていません
```
**解決方法**: GitHub SecretsにAWS認証情報を正しく設定してください。

#### Terraform設定エラー
```
Error: Invalid Terraform configuration
```
**解決方法**: Terraform設定ファイルの構文を確認してください。

#### ドメイン登録エラー
```
Error: Domain already registered
```
**解決方法**: 既存のドメインを使用するか、別のドメイン名を選択してください。

### 2. ログの確認

各ステップのログはGitHub Actionsの実行履歴で確認できます：

1. GitHubリポジトリの「Actions」タブに移動
2. 「Terraform Configuration Management」を選択
3. 実行履歴を選択
4. 各ジョブのログを確認

### 3. 手動復旧

設定ファイルの生成に失敗した場合：

1. 手動で設定ファイルを修正
2. ワークフローの再実行
3. 必要に応じてAWSコンソールで確認

## 元のスクリプトとの違い

### 1. 改善点
- **可視性**: GitHub Actionsのダッシュボードで実行状況を確認
- **履歴管理**: 実行履歴の永続化
- **自動化**: 手動入力から自動化への移行
- **検証機能**: 設定ファイルの自動検証
- **バックアップ**: 設定変更前の自動バックアップ

### 2. 制限事項
- **対話的入力**: 手動承認が必要な場合がある
- **ローカル実行**: ローカルでの直接実行は不可
- **ネットワーク依存**: GitHub Actionsの実行環境に依存

## 今後の拡張

### 1. 追加機能
- 複数環境の同時設定
- カスタムテンプレートのサポート
- 設定の差分表示
- 自動テスト機能

### 2. 最適化
- 並行処理の最適化
- キャッシュ機能の追加
- 実行時間の短縮

## サポート

問題や質問がある場合は、GitHub Issuesで報告してください。 