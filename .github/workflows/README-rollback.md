# Rollback Production Environment Workflow

## 概要

このワークフローは、本番環境を以前の状態にロールバックするためのGitHub Actionsワークフローです。元の`scripts/maintenance/rollback.sh`スクリプトを置き換えます。

## 機能

### 主要な処理

1. **設定ファイルの検証**
   - `deployment_config.json`の必須フィールドをチェック
   - JSON形式の妥当性を確認

2. **利用可能なスナップショットの確認**
   - 手動作成されたRDSスナップショットをリスト表示
   - 最新のスナップショットを特定

3. **本番環境のロールバック**
   - 本番RDSインスタンスの停止
   - スナップショットからの復元
   - WordPressファイルの復元

4. **動作確認**
   - ロールバック後のサイト動作確認
   - システムの安定化待機

## トリガー

### 自動実行
- `main`ブランチへのプッシュ
- `scripts/maintenance/rollback.sh`または`deployment_config.json`の変更時

### 手動実行
- GitHub Actions UIからの手動実行
- 以下の入力パラメータを指定可能：
  - `snapshot_id`: 特定のスナップショットID（オプション）
  - `dry_run`: ドライランモード
  - `auto_approve`: 自動承認

## 必要な設定

### GitHub Secrets
- `AWS_ACCESS_KEY_ID`: AWSアクセスキーID
- `AWS_SECRET_ACCESS_KEY`: AWSシークレットアクセスキー
- `SSH_PRIVATE_KEY`: SSH秘密鍵（EC2接続用）

### 設定ファイル
`deployment_config.json`に以下のフィールドが必要：

```json
{
  "production": {
    "ec2_instance_id": "i-xxxxxxxxx",
    "rds_identifier": "wp-shamo-rds",
    "wordpress_url": "https://example.com"
  }
}
```

## ワークフローの流れ

### 1. validate-config
- 設定ファイルの存在確認
- 必須フィールドの検証
- JSON形式の妥当性チェック

### 2. check-snapshots
- AWS認証情報の設定
- 利用可能なスナップショットのリスト表示
- 最新のスナップショットIDの取得

### 3. rollback-production
- AWS認証情報の設定
- 設定ファイルからの値読み込み
- 手動承認（auto_approveがfalseの場合）
- 本番RDSインスタンスの停止
- スナップショットからの復元
- WordPressファイルの復元
- システム安定化待機
- 動作確認

### 4. notify-completion
- 成功/失敗の通知
- Slack通知の準備（コメントアウト）

## セキュリティ機能

### 手動承認
- 本番環境のロールバックには手動承認が必要
- GitHub Actions UIで承認を実行
- `auto_approve`設定で自動承認も可能

### スナップショット選択
- 特定のスナップショットIDを指定可能
- 指定がない場合は最新のスナップショットを使用

### SSH認証
- SSH秘密鍵を使用したEC2接続
- GitHub Secretsで秘密鍵を管理

## エラーハンドリング

### 設定エラー
- 設定ファイルが見つからない場合
- 必須フィールドが不足している場合
- JSON形式が不正な場合

### スナップショットエラー
- 利用可能なスナップショットが見つからない場合
- 指定されたスナップショットが存在しない場合

### 復元エラー
- RDS復元失敗
- WordPressファイル復元失敗
- 接続テスト失敗

### タイムアウト
- 復元後の動作確認待機（15回試行、10秒間隔）

## 出力情報

### ロールバック情報
- 使用したスナップショットID
- WordPressバックアップファイル名
- 本番環境URL

### ログ
- 各ステップの実行状況
- エラーメッセージ
- 成功メッセージ

## 復旧オプション

### スナップショットからの復元
- 手動作成されたRDSスナップショットを使用
- データベースの完全な復元

### WordPressファイルの復元
- バックアップファイルからの復元
- ファイルが見つからない場合は手動復元が必要

## トラブルシューティング

### よくある問題

1. **スナップショットが見つからない**
   - 手動作成されたスナップショットが存在するか確認
   - スナップショットの状態を確認

2. **RDS復元失敗**
   - RDSインスタンスの状態を確認
   - スナップショットの整合性を確認

3. **WordPressファイル復元失敗**
   - バックアップファイルの存在を確認
   - EC2インスタンスのディスク容量を確認

4. **動作確認失敗**
   - システムの安定化時間を延長
   - ネットワーク接続を確認

### デバッグ方法

1. **ログの確認**
   - GitHub Actionsのログを詳細に確認
   - エラーメッセージの内容を確認

2. **手動確認**
   - AWSコンソールでリソースの状態を確認
   - 本番環境への直接アクセスを試行

3. **段階的復元**
   - データベースとファイルを個別に復元
   - 各段階での動作確認

## 次のステップ

ロールバックが失敗した場合、以下のワークフローを使用できます：

1. **Prepare Validation**: 検証環境の準備
2. **Deploy to Production**: 本番環境への再デプロイ

## 注意事項

- ロールバックは本番環境に影響を与える重要な操作です
- ロールバック前に必ず手動承認を取得してください
- スナップショットは手動作成されたもののみ使用されます
- WordPressファイルのバックアップがない場合、手動復元が必要です
- ロールバック後は十分なテストを実行してください
